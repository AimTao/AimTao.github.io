<!DOCTYPE html><html lang="en" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="manifest" href="/manifest.json"><link rel="apple-touch-icon" sizes="76x76" href="https://hutu0.aimtao.net/web/icon.jpeg"><link rel="icon" href="https://hutu0.aimtao.net/web/icon.jpeg"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="AimTao"><meta name="keywords" content="C++,Python,Go,算法，开发,blog,后端,记录"><meta name="description" content="0.序言 1.服务端与消息编码 2.高性能客户端 3.服务注册 这一章是干什么的？ 服务端的主要工作：  监听端口 响应请求  解析请求 处理请求  从请求中获取方法名、参数 获取方法 调用方法   返回结果    这一章主要完成处理请求部分，其中，从请求中获取方法名、参数在上一章已完成。client 在发送请求时，方法名在请求头里 client.header.ServiceMethod，参数在请"><title>从零实现系列｜RPC - AimTao</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_2113603_2ltiep6fmf8.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"www.aimtao.net",root:"/",version:"1.9.1",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:"❡"},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"sh"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h2,h3,h4",collapseDepth:2},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!0,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!1,baidu:"07fe5d228ae82eadee00480515f9d64b",google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:"hkFccy0TBvlTMrTD2n9MwSIx-gzGzoHsz",app_key:"yUJSgy6kcnRscdGX9ec7jlFz",server_url:"https://analytics.aimtao.net",path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml"};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><style type="text/css">.spoiler{display:inline}p.spoiler{display:flex}.spoiler a{pointer-events:none}.spoiler-blur,.spoiler-blur>*{transition:text-shadow .5s ease}.spoiler .spoiler-blur,.spoiler .spoiler-blur>*{color:transparent;background-color:rgba(0,0,0,0);text-shadow:0 0 10px grey;cursor:pointer}.spoiler .spoiler-blur:hover,.spoiler .spoiler-blur:hover>*{text-shadow:0 0 5px grey}.spoiler-box,.spoiler-box>*{transition:color .5s ease,background-color .5s ease}.spoiler .spoiler-box,.spoiler .spoiler-box>*{color:#000;background-color:#000;text-shadow:none}</style><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="AimTao" type="application/atom+xml">
</head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>AimTao&#39;s Blog</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> Home</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> Categories</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> Tags</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> About</a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> Links</a></li><li class="nav-item"><a class="nav-link" href="/atom.xml"><i class="iconfont icon-rss"></i> RSS</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="iconfont icon-archive-fill"></i> Archives</a><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/archives/">Timeline </a><a class="dropdown-item" href="/tags/Kernel/">Linux kernel </a><a class="dropdown-item" href="/categories/Mark/">Mark</a></div></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(https://hutu.aimtao.net/web/post_banner.webp-ss) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="从零实现系列｜RPC"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2024-10-18 22:36" pubdate>2024-10-18 PM</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 45k words </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 34 mins</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">从零实现系列｜RPC</h1><div class="markdown-body"><h2 id="0-序言">0.序言</h2><h2 id="1-服务端与消息编码">1.服务端与消息编码</h2><h2 id="2-高性能客户端">2.高性能客户端</h2><h2 id="3-服务注册">3.服务注册</h2><h3 id="这一章是干什么的？">这一章是干什么的？</h3><p>服务端的主要工作：</p><ul><li>监听端口</li><li>响应请求<ul><li>解析请求</li><li>处理请求<ul><li>从请求中获取方法名、参数</li><li>获取方法</li><li>调用方法</li></ul></li><li>返回结果</li></ul></li></ul><p>这一章主要完成处理请求部分，其中，从请求中获取方法名、参数在上一章已完成。client 在发送请求时，方法名在请求头里 <code>client.header.ServiceMethod</code>，参数在请求体里 <code>call.Args</code>。</p><p>所以我们重点关注</p><ul><li>获取方法</li><li>调用方法</li></ul><h3 id="如何获取方法">如何获取方法</h3><p>服务端通过方法名获取实际的方法，需要两步：</p><ol><li><p>在启动服务端服务时，我们可以将所有可调用的方法都加到一个 map 中。</p></li><li><p>当 client 调用 hello 时，我们从 map 中找到对应的方法皆可。</p></li></ol><p>由于不同类型的结构体，可能有同名的结构体方法。我们的方法名，使用 <code>结构体实例名.方法名</code> 来作为方法名。比如上一章中的，结构体类型 <code>Foo</code> ，有 <code>Sum</code> 方法，客户端实例化 <code>foo</code> 对象后，远程调用 Client.Call 时，传入的就是 <code>foo.Sum</code>。</p><h3 id="如何方法注册到-map-中">如何方法注册到 map 中</h3><p>首先，先说数据存储方式，简单来说是这样的，</p><pre><code class="mermaid">flowchart LR
    A[Server.serviceMap] --&gt;|map储存多个service| B[Service&lt;br&gt;一个 service 表示一个变量类型]
    B --&gt;|service包含一个 map 变量| C[service.method]
    C --&gt;|map 储存多个方法| D[methodType&lt;br&gt;一个 methodType 表示一个该变量类型的方法]
 
</code></pre><p>具体数据存储方式设计如下：</p><p>服务端保存着一个 serviceMap。使用 serviceMap 保存变量类型及其方法。key 是变量类型名，value 是 service 类型实例。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// server.go</span><br><span class="hljs-comment">// Server 定义 Server 结构体，封装了 Accept、ServeConn、serveCodec 方法</span><br><span class="hljs-keyword">type</span> Server <span class="hljs-keyword">struct</span> &#123;<br>    serviceMap sync.Map<br>&#125;<br></code></pre></td></tr></table></figure><p>service 类型定义如下，一个 service 表示一个变量类型。其中，也包含一个 map，保存着这个变量的方法。key 是方法名，value 是 methodType 类型实例。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// service.go</span><br><span class="hljs-comment">// 一个 service 表示一个变量类型</span><br><span class="hljs-keyword">type</span> service <span class="hljs-keyword">struct</span> &#123;<br>    name   <span class="hljs-type">string</span>                 <span class="hljs-comment">// 变量类型名，用来打 log，例如字符串 &quot;Foo&quot;</span><br>    typ    reflect.Type           <span class="hljs-comment">// 变量类型，通过变量的类型，可以直接获取变量的方法，例如 Foo 类型，可获取到方法 Sum</span><br>    rcvr   reflect.Value          <span class="hljs-comment">// 变量的值，通过变量的值，可以调用变量的方法，例如 &amp;foo，调用 Sum</span><br>    method <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]*methodType <span class="hljs-comment">//  map 储存变量的方法中所有可调用的方法</span><br>&#125;<br></code></pre></td></tr></table></figure><p>methodType 类型定义如下，一个 methodType 表示一个方法。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// service.go</span><br><span class="hljs-comment">// 一个 methodType 表示一个方法</span><br><span class="hljs-keyword">type</span> methodType <span class="hljs-keyword">struct</span> &#123;<br>    method    reflect.Method <span class="hljs-comment">// 方法本身，用于调用方法，例如 Foo.Sum</span><br>    ArgType   reflect.Type   <span class="hljs-comment">// 参数的类型，用于判断参数是否正确</span><br>    ReplyType reflect.Type   <span class="hljs-comment">// 返回的类型，用于判断返回值是否正确</span><br>    numCalls  <span class="hljs-type">uint64</span>         <span class="hljs-comment">// 方法调用次数，用于统计方法调用次数</span><br>&#125;<br></code></pre></td></tr></table></figure><p>最后，下面将以一个实际例子，演示如何将方法注册到 map 中。</p><pre><code class="mermaid">graph LR
A[startServer, 启动服务器] --&gt; B[Server.Register , 为 Foo 类型注册服务]
B --&gt; C[newService, 为 Foo 类型创建 service 结构体]
C --&gt; D[获取 rcvr 值, 类型名和类型]
C --&gt; G[service.registerMethods, 获取方法列表]
G --&gt; K[检查方法的参数和返回值]
K --&gt; L[保存方法到 map 变量 service.method]
</code></pre><ol><li>启动服务，将 Foo 类型注册到 rpc server 中。</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// main.go</span><br><br><span class="hljs-keyword">type</span> Foo <span class="hljs-type">int</span> <span class="hljs-comment">// Foo 类型，实现了 Sum 方法</span><br><span class="hljs-keyword">type</span> Args <span class="hljs-keyword">struct</span>&#123; Num1, Num2 <span class="hljs-type">int</span> &#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f Foo)</span></span> Sum(args Args, reply *<span class="hljs-type">int</span>) <span class="hljs-type">error</span> &#123;<br>    *reply = args.Num1 + args.Num2<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">startServer</span><span class="hljs-params">(addr <span class="hljs-keyword">chan</span> <span class="hljs-type">string</span>)</span></span> &#123;<br><br>    <span class="hljs-keyword">var</span> foo Foo                                   <span class="hljs-comment">// 实例化 Foo 类型的对象</span><br>    <span class="hljs-keyword">if</span> err := geerpc.Register(&amp;foo); err != <span class="hljs-literal">nil</span> &#123; <span class="hljs-comment">// 注册 Foo 类型的对象，注册的是 Foo 类型的对象，不是 Foo 类型的方法</span><br>        log.Fatal(<span class="hljs-string">&quot;register error:&quot;</span>, err)<br>    &#125;<br><br>    l, err := net.Listen(<span class="hljs-string">&quot;tcp&quot;</span>, <span class="hljs-string">&quot;:0&quot;</span>)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        log.Fatal(<span class="hljs-string">&quot;network error:&quot;</span>, err)<br>    &#125;<br>    log.Println(<span class="hljs-string">&quot;start rpc server on&quot;</span>, l.Addr())<br>    addr &lt;- l.Addr().String()<br>    geerpc.Accept(l)<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>为 Foo 类型创建 service 对象，并保存到 server 的 map 中。</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// server.go</span><br><span class="hljs-keyword">var</span> DefaultServer = NewServer()<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Register</span><span class="hljs-params">(rcvr <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> <span class="hljs-type">error</span> &#123; <span class="hljs-keyword">return</span> DefaultServer.Register(rcvr) &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(server *Server)</span></span> Register(rcvr <span class="hljs-keyword">interface</span>&#123;&#125;) <span class="hljs-type">error</span> &#123;<br>    s := newService(rcvr)                                        <span class="hljs-comment">// 为 rcvr 变量的类型创建 service 结构体</span><br>    <span class="hljs-keyword">if</span> _, dup := server.serviceMap.LoadOrStore(s.name, s); dup &#123; <span class="hljs-comment">// 调用 serviceMap.LoadOrStore 将 service 结构体保存到 map 中</span><br>        <span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">&quot;rpc: service already defined: &quot;</span> + s.name)<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>创建 service 对象、获取对象的方法、检查方法参数和返回值，最后将方法保存到 map 中。</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// service.go</span><br><span class="hljs-comment">// newService 通过发射获取 rcvr 变量的类型及其方法</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">newService</span><span class="hljs-params">(rcvr <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> *service &#123;<br>    s := <span class="hljs-built_in">new</span>(service)<br>    s.rcvr = reflect.ValueOf(rcvr)                  <span class="hljs-comment">// 获取 rcvr 变量的值，例如 &amp;foo</span><br>    s.name = reflect.Indirect(s.rcvr).Type().Name() <span class="hljs-comment">// 获取 rcvr 变量的类型名，例如 &quot;Foo&quot;</span><br>    s.typ = reflect.TypeOf(rcvr)                    <span class="hljs-comment">// 获取 rcvr 变量的类型，例如 Foo</span><br>    <span class="hljs-keyword">if</span> !ast.IsExported(s.name) &#123;<br>        log.Fatalf(<span class="hljs-string">&quot;rpc server: %s is not a valid service name&quot;</span>, s.name)<br>    &#125;<br>    s.registerMethods() <span class="hljs-comment">// 获取 rcvr 变量的方法列表，例如 Foo.Sum，并将其保存到 service 的方法 map 中</span><br>    <span class="hljs-keyword">return</span> s<br>&#125;<br><br><span class="hljs-comment">// registerMethods 获取 rcvr 变量的方法列表，例如 Foo.Sum，并将其保存到 service 的方法 map 中</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *service)</span></span> registerMethods() &#123;<br>    s.method = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]*methodType)<br><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; s.typ.NumMethod(); i++ &#123; <span class="hljs-comment">// 遍历 rcvr 变量的方法列表</span><br>        method := s.typ.Method(i) <span class="hljs-comment">// 获取 rcvr 变量，第 i 个方法</span><br>        mType := method.Type      <span class="hljs-comment">// 获取 rcvr 变量的方法的类型</span><br><br>        <span class="hljs-comment">// 检查方法的参数是否正确。rpc 的方法必须满足以下条件：</span><br>        <span class="hljs-comment">// 1. 方法有 3 个参数，第 1 个参数是 rcvr 变量(相当于 python 的 self，java 的 this)，第 2 个参数是传入参数，第 3 个参数是传出参数，指针类型</span><br>        <span class="hljs-comment">// 2. 第 2 个参数和第 3 个参数都是导出的类型</span><br>        <span class="hljs-comment">// 3. 返回值只有一个，是 error 类型</span><br>        <span class="hljs-comment">// 例如这样 func (t *T) MethodName(argType T1, replyType *T2) error</span><br>        <span class="hljs-keyword">if</span> mType.NumIn() != <span class="hljs-number">3</span> || mType.NumOut() != <span class="hljs-number">1</span> &#123; <span class="hljs-comment">// 检查参数个数</span><br>            <span class="hljs-keyword">continue</span><br>        &#125;<br>        <span class="hljs-keyword">if</span> mType.Out(<span class="hljs-number">0</span>) != reflect.TypeOf((*<span class="hljs-type">error</span>)(<span class="hljs-literal">nil</span>)).Elem() &#123; <span class="hljs-comment">// 检测返回值个数和类型</span><br>            <span class="hljs-keyword">continue</span><br>        &#125;<br>        argType, replyType := mType.In(<span class="hljs-number">1</span>), mType.In(<span class="hljs-number">2</span>)<br>        <span class="hljs-keyword">if</span> !isExportedOrBuiltinType(argType) || !isExportedOrBuiltinType(replyType) &#123; <span class="hljs-comment">// 检查参数类型是否是导出的类型或者内置类型</span><br>            <span class="hljs-keyword">continue</span><br>        &#125;<br><br>        <span class="hljs-comment">// 检查完毕，将方法保存到 service 的方法 map 中</span><br>        s.method[method.Name] = &amp;methodType&#123;<br>            method:    method,<br>            ArgType:   argType,<br>            ReplyType: replyType,<br>        &#125;<br>        log.Printf(<span class="hljs-string">&quot;rpc server: register %s.%s\n&quot;</span>, s.name, method.Name)<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// isExportedOrBuiltinType 检查类型是否是导出的类型或者内置类型</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">isExportedOrBuiltinType</span><span class="hljs-params">(t reflect.Type)</span></span> <span class="hljs-type">bool</span> &#123;<br>    <span class="hljs-keyword">return</span> ast.IsExported(t.Name()) || t.PkgPath() == <span class="hljs-string">&quot;&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="如何从-map-获取方法">如何从 map 获取方法</h3><p>在 readRequest 时，从请求头中，获取方法名；根据方法名在对应的 service 的 map 中获取到方法、传入参数、传出参数。</p><pre><code class="mermaid">graph LR
A[Server.readRequest] --&gt;|解析请求头| B[Server.readRequestHeader]
B--&gt;|返回请求头,包含方法名| A
A --&gt;|获取方法| C[Server.findService]
A --&gt;|获取方法传入参数,传出参数| D[GobCodec.ReadBody]
E[request]
C--&gt;|方法保存到 request| E
D--&gt;|传入参数,传出参数保存到 request| E
</code></pre><ol><li>request 储存了一次远程调用请求的信息，方法、传入参数、传出参数指针。它的定义如下。</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// server.go</span><br><span class="hljs-comment">// request 表示一次调用的所有信息</span><br><span class="hljs-keyword">type</span> request <span class="hljs-keyword">struct</span> &#123;<br>    h            *codec.Header <span class="hljs-comment">// 请求头</span><br>    svc          *service      <span class="hljs-comment">// 请求对应的服务，使用 svc.call 调用对应的方法</span><br>    mtype        *methodType   <span class="hljs-comment">// 请求对应的方法，是 svc.call 的第一个参数</span><br>    argv, replyv reflect.Value <span class="hljs-comment">// 方法的传入参数和传出参数，是 svc.call 的第二个和第三个参数</span><br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>readRequest 获取方法名、方法、传入参数、传出参数，并储存在 request 实例中，为方法调用做准备。</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// server.go</span><br><span class="hljs-comment">// readRequest 读取请求：调用 readRequestHeader 方法读取请求头，调用 ReadBody 方法读取请求参数，返回 request 结构体</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(server *Server)</span></span> readRequest(cc codec.Codec) (*request, <span class="hljs-type">error</span>) &#123;<br>    <span class="hljs-comment">// 读取请求头</span><br>    h, err := server.readRequestHeader(cc)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>    &#125;<br><br>    <span class="hljs-comment">// 初始化请求结构体</span><br>    req := &amp;request&#123;h: h&#125;<br><br>    <span class="hljs-comment">// 根据请求头中的 ServiceMethod 字段找到对应的服务和方法类型</span><br>    req.svc, req.mtype, err = server.findService(h.ServiceMethod)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> req, err<br>    &#125;<br><br>    <span class="hljs-comment">// 创建传入参数和传出参数的反射对象</span><br>    req.argv = req.mtype.newArgv()<br>    req.replyv = req.mtype.newReplyv()<br><br>    <span class="hljs-comment">// 检查请求传入参数的类型是否为指针类型，如果不是，则使用 Addr() 方法将 req.argv 转换为指针类型</span><br>    <span class="hljs-comment">// 为什么？</span><br>    <span class="hljs-comment">// 因为如果传入值是值类型，传入后，是值拷贝，不会修改传入变量的原值，所以需要使用 Addr() 获取地址后传入。</span><br>    argvi := req.argv.Interface() <span class="hljs-comment">// 使用 interface() 方法将 req.argv 转换为 interface&#123;&#125; 类型，这样可以传入任意类型的参数</span><br>    <span class="hljs-keyword">if</span> req.argv.Type().Kind() != reflect.Ptr &#123;<br>        argvi = req.argv.Addr().Interface()<br>    &#125;<br><br>    <span class="hljs-comment">// ReadBody 方法会将请求参数解码到 argvi 中储存</span><br>    <span class="hljs-keyword">if</span> err = cc.ReadBody(argvi); err != <span class="hljs-literal">nil</span> &#123;<br>        log.Println(<span class="hljs-string">&quot;rpc server: read body err:&quot;</span>, err)<br>        <span class="hljs-keyword">return</span> req, err<br>    &#125;<br>    <span class="hljs-keyword">return</span> req, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>另外，需要注意一下，</p><ul><li>创建传入参数时，需区分值类型还是指针类型。</li><li>创建传出参数时，需对 map、slice 特殊处理。（因为 reflect.New 初始化时，map、slice 都是 nil）</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// service.go</span><br><span class="hljs-comment">// newArgv 创建一个参数变量</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *methodType)</span></span> newArgv() reflect.Value &#123;<br>    <span class="hljs-keyword">var</span> argv reflect.Value<br>    <span class="hljs-comment">// 参数可能是指针类型也可能是值类型</span><br>    <span class="hljs-keyword">if</span> m.ArgType.Kind() == reflect.Ptr &#123;<br>        argv = reflect.New(m.ArgType.Elem()) <span class="hljs-comment">// 指针类型，则创建指针类型变量</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        argv = reflect.New(m.ArgType).Elem() <span class="hljs-comment">// 值类型，则创建值类型变量</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> argv<br>&#125;<br><br><span class="hljs-comment">// newReplyv 创建一个传出参数变量</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *methodType)</span></span> newReplyv() reflect.Value &#123;<br>    <span class="hljs-comment">// 传出参数必须是指针类型</span><br>    replyv := reflect.New(m.ReplyType.Elem())<br><br>    <span class="hljs-comment">// 为什么需要对 map 和 slice 特殊处理？</span><br>    <span class="hljs-comment">// reflect.New 创建的 map 和 slice 都是 nil，需要先初始化，再使用。</span><br>    <span class="hljs-comment">// 为什么 newArgv 方法不需要对 map 和 slice 特殊处理？</span><br>    <span class="hljs-comment">// 因为 argv 是用于接收调用方传入的参数，这些参数由调用方提供且已经初始化。</span><br>    <span class="hljs-keyword">switch</span> m.ReplyType.Elem().Kind() &#123;<br>    <span class="hljs-keyword">case</span> reflect.Map:<br>        replyv.Elem().Set(reflect.MakeMap(m.ReplyType.Elem()))<br>    <span class="hljs-keyword">case</span> reflect.Slice:<br>        replyv.Elem().Set(reflect.MakeSlice(m.ReplyType.Elem(), <span class="hljs-number">0</span>, <span class="hljs-number">0</span>))<br>    &#125;<br>    <span class="hljs-keyword">return</span> replyv<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="如何调用方法">如何调用方法</h3><p>在 handleRequest 时，通过 service.call 利用反射来调用函数。这里主要学习这个用法。</p><pre><code class="mermaid">graph LR
A[Server.serveCodec]--&gt;|获取请求信息| B[Server.readRequest] 
A --&gt;|调用方法| C[Server.handleRequest]
C --&gt; D[request.svc.call, 也就是 Service.call]
D --&gt;|使用反射调用| E[methodType.method.Func.Call]
</code></pre><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// server.go</span><br><span class="hljs-comment">// handleRequest 处理请求：构造请求响应信息，调用 sendResponse 方法发送响应</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(server *Server)</span></span> handleRequest(cc codec.Codec, req *request, sending *sync.Mutex, wg *sync.WaitGroup) &#123;<br>    <span class="hljs-keyword">defer</span> wg.Done()<br><br>    err := req.svc.call(req.mtype, req.argv, req.replyv) <span class="hljs-comment">// 调用</span><br><br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        req.h.Error = err.Error()<br>        server.sendResponse(cc, req.h, invalidRequest, sending)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    server.sendResponse(cc, req.h, req.replyv.Interface(), sending)<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// service.go</span><br><span class="hljs-comment">// call 调用 rcvr 变量的方法，例如 Foo.Sum</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *service)</span></span> call(m *methodType, argv, replyv reflect.Value) <span class="hljs-type">error</span> &#123;<br>    atomic.AddUint64(&amp;m.numCalls, <span class="hljs-number">1</span>)<br>    f := m.method.Func<br>    <span class="hljs-comment">// 用反射的方式调用方法</span><br>    <span class="hljs-comment">// 第一个参数是 rcvr 变量，例如 &amp;foo，类似于 java 的 this，python 的 self</span><br>    <span class="hljs-comment">// 第 2 个参数是传入参数，第 3 个参数是传出参数，指针类型</span><br>    returnValues := f.Call([]reflect.Value&#123;s.rcvr, argv, replyv&#125;)<br>    <span class="hljs-keyword">if</span> errInter := returnValues[<span class="hljs-number">0</span>].Interface(); errInter != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> errInter.(<span class="hljs-type">error</span>)<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="更深入了解反射">更深入了解反射</h3><p>请看这篇 <a href="https://www.aimtao.net/go#11-reflect">https://www.aimtao.net/go#11-reflect</a></p><h3 id="完整代码">完整代码</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 代码结构</span><br>version_3_service[geerpc]<br>├── client.go<br>├── codec<br>│   ├── codec.go<br>│   └── gob.go<br>├── go.mod<br>├── main<br>│   └── main.go (改动)<br>├── server.go (改动)<br>├── service.go (改动)<br>└── service_test.go (改动)<br></code></pre></td></tr></table></figure><div class="fold collapsed"><div class="fold-title">main/main.go</div><div class="fold-content"><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>    geerpc <span class="hljs-string">&quot;GeeRPC&quot;</span><br>    <span class="hljs-string">&quot;log&quot;</span><br>    <span class="hljs-string">&quot;net&quot;</span><br>    <span class="hljs-string">&quot;sync&quot;</span><br>    <span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> Foo <span class="hljs-type">int</span> <span class="hljs-comment">// Foo 类型，实现了 Sum 方法</span><br><span class="hljs-keyword">type</span> Args <span class="hljs-keyword">struct</span>&#123; Num1, Num2 <span class="hljs-type">int</span> &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f Foo)</span></span> Sum(args Args, reply *<span class="hljs-type">int</span>) <span class="hljs-type">error</span> &#123;<br>    *reply = args.Num1 + args.Num2<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">startServer</span><span class="hljs-params">(addr <span class="hljs-keyword">chan</span> <span class="hljs-type">string</span>)</span></span> &#123;<br><br>    <span class="hljs-keyword">var</span> foo Foo                                   <span class="hljs-comment">// 实例化 Foo 类型的对象</span><br>    <span class="hljs-keyword">if</span> err := geerpc.Register(&amp;foo); err != <span class="hljs-literal">nil</span> &#123; <span class="hljs-comment">// 注册 Foo 类型的对象，注册的是 Foo 类型的对象，不是 Foo 类型的方法</span><br>        log.Fatal(<span class="hljs-string">&quot;register error:&quot;</span>, err)<br>    &#125;<br><br>    l, err := net.Listen(<span class="hljs-string">&quot;tcp&quot;</span>, <span class="hljs-string">&quot;:0&quot;</span>)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        log.Fatal(<span class="hljs-string">&quot;network error:&quot;</span>, err)<br>    &#125;<br>    log.Println(<span class="hljs-string">&quot;start rpc server on&quot;</span>, l.Addr())<br>    addr &lt;- l.Addr().String()<br>    geerpc.Accept(l)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    log.SetFlags(<span class="hljs-number">0</span>)<br><br>    addr := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">string</span>)<br>    <span class="hljs-keyword">go</span> startServer(addr)<br><br>    client, _ := geerpc.Dial(<span class="hljs-string">&quot;tcp&quot;</span>, &lt;-addr)<br>    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; _ = client.Close() &#125;()<br><br>    time.Sleep(time.Second)<br>    <span class="hljs-comment">// send request &amp; receive response</span><br>    <span class="hljs-keyword">var</span> wg sync.WaitGroup<br><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++ &#123;<br>        wg.Add(<span class="hljs-number">1</span>)<br><br>        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i <span class="hljs-type">int</span>)</span></span> &#123;<br>            <span class="hljs-keyword">defer</span> wg.Done()<br>            args := &amp;Args&#123;Num1: i, Num2: i * i&#125;<br>            <span class="hljs-keyword">var</span> reply <span class="hljs-type">int</span><br>            <span class="hljs-keyword">if</span> err := client.Call(<span class="hljs-string">&quot;Foo.Sum&quot;</span>, args, &amp;reply); err != <span class="hljs-literal">nil</span> &#123;<br>                log.Fatal(<span class="hljs-string">&quot;call Foo.Sum error:&quot;</span>, err)<br>            &#125;<br>            log.Printf(<span class="hljs-string">&quot;%d + %d = %d&quot;</span>, args.Num1, args.Num2, reply)<br>        &#125;(i)<br>    &#125;<br>    wg.Wait()<br>&#125;<br></code></pre></td></tr></table></figure></div></div><div class="fold collapsed"><div class="fold-title">server.go</div><div class="fold-content"><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> geerpc<br><br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;GeeRPC/codec&quot;</span><br>    <span class="hljs-string">&quot;encoding/json&quot;</span><br>    <span class="hljs-string">&quot;errors&quot;</span><br>    <span class="hljs-string">&quot;io&quot;</span><br>    <span class="hljs-string">&quot;log&quot;</span><br>    <span class="hljs-string">&quot;net&quot;</span><br>    <span class="hljs-string">&quot;reflect&quot;</span><br>    <span class="hljs-string">&quot;strings&quot;</span><br>    <span class="hljs-string">&quot;sync&quot;</span><br>)<br><br><span class="hljs-keyword">const</span> MagicNumber = <span class="hljs-number">0x3bef5c</span><br><br><span class="hljs-comment">// Option 定义 Option 结构体，封装了 MagicNumber 和 CodecType 字段，从 conn 中解析出 Option 的信息，表示 RPC 消息的编码方式</span><br><span class="hljs-keyword">type</span> Option <span class="hljs-keyword">struct</span> &#123;<br>    MagicNumber <span class="hljs-type">int</span><br>    CodecType   codec.Type<br>&#125;<br><br><span class="hljs-comment">// Server 定义 Server 结构体，封装了 Accept、ServeConn、serveCodec 方法</span><br><span class="hljs-keyword">type</span> Server <span class="hljs-keyword">struct</span> &#123;<br>    serviceMap sync.Map<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewServer</span><span class="hljs-params">()</span></span> *Server &#123;<br>    <span class="hljs-keyword">return</span> &amp;Server&#123;&#125;<br>&#125;<br><br><span class="hljs-comment">// Accept 处理连接：建立 socket 连接，使用 goroutine 处理连接</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(server *Server)</span></span> Accept(lis net.Listener) &#123;<br>    <span class="hljs-keyword">for</span> &#123;<br>        conn, err := lis.Accept() <span class="hljs-comment">// 建立 socket 连接</span><br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            log.Println(<span class="hljs-string">&quot;rpc server: accept error: &quot;</span>, err)<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-keyword">go</span> server.ServeConn(conn) <span class="hljs-comment">// 使用 goroutine 处理连接</span><br>    &#125;<br><br>&#125;<br><br><span class="hljs-comment">// ServeConn 处理消息：解析出 Option 信息，根据 CodecType 选择对应的 codec，调用 serveCodec 方法处理剩下的消息</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(server *Server)</span></span> ServeConn(conn io.ReadWriteCloser) &#123;<br><br>    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>        _ = conn.Close()<br>    &#125;()<br><br>    <span class="hljs-keyword">var</span> opt Option<br>    <span class="hljs-keyword">if</span> err := json.NewDecoder(conn).Decode(&amp;opt); err != <span class="hljs-literal">nil</span> &#123; <span class="hljs-comment">// opt 是传出参数，读到 RPC 前面的 JSON 数据，这包含了 option 信息，表示 RPC 消息的编码方式</span><br>        log.Println(<span class="hljs-string">&quot;rpc server: options error: &quot;</span>, err)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    <span class="hljs-keyword">if</span> opt.MagicNumber != MagicNumber &#123;<br>        log.Printf(<span class="hljs-string">&quot;rpc server: invalid magic number %x&quot;</span>, opt.MagicNumber)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    f := codec.NewCodecFuncMap[opt.CodecType]<br>    <span class="hljs-keyword">if</span> f == <span class="hljs-literal">nil</span> &#123;<br>        log.Printf(<span class="hljs-string">&quot;rpc server: invalid codec type %s&quot;</span>, opt.CodecType)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    server.serveCodec(f(conn))<br>&#125;<br><br><span class="hljs-comment">// serveCodec 处理请求：调用 readRequest 方法读取请求，调用 handleRequest 方法处理请求</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(server *Server)</span></span> serveCodec(cc codec.Codec) &#123;<br>    sending := <span class="hljs-built_in">new</span>(sync.Mutex)<br>    wg := <span class="hljs-built_in">new</span>(sync.WaitGroup)<br><br>    <span class="hljs-keyword">for</span> &#123;<br>        req, err := server.readRequest(cc)<br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            <span class="hljs-keyword">break</span><br>        &#125;<br><br>        wg.Add(<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">go</span> server.handleRequest(cc, req, sending, wg)<br>    &#125;<br>    wg.Wait()<br>    _ = cc.Close()<br>&#125;<br><br><span class="hljs-comment">// request 表示一次调用的所有信息</span><br><span class="hljs-keyword">type</span> request <span class="hljs-keyword">struct</span> &#123;<br>    h            *codec.Header <span class="hljs-comment">// 请求头</span><br>    svc          *service      <span class="hljs-comment">// 请求对应的服务，使用 svc.call 调用对应的方法</span><br>    mtype        *methodType   <span class="hljs-comment">// 请求对应的方法，是 svc.call 的第一个参数</span><br>    argv, replyv reflect.Value <span class="hljs-comment">// 方法的传入参数和传出参数，是 svc.call 的第二个和第三个参数</span><br>&#125;<br><br><span class="hljs-comment">// readRequest 读取请求：调用 readRequestHeader 方法读取请求头，调用 ReadBody 方法读取请求参数，返回 request 结构体</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(server *Server)</span></span> readRequest(cc codec.Codec) (*request, <span class="hljs-type">error</span>) &#123;<br>    <span class="hljs-comment">// 读取请求头</span><br>    h, err := server.readRequestHeader(cc)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>    &#125;<br><br>    <span class="hljs-comment">// 初始化请求结构体</span><br>    req := &amp;request&#123;h: h&#125;<br><br>    <span class="hljs-comment">// 根据请求头中的 ServiceMethod 字段找到对应的服务和方法类型</span><br>    req.svc, req.mtype, err = server.findService(h.ServiceMethod)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> req, err<br>    &#125;<br><br>    <span class="hljs-comment">// 创建传入参数和传出参数的反射对象</span><br>    req.argv = req.mtype.newArgv()<br>    req.replyv = req.mtype.newReplyv()<br><br>    <span class="hljs-comment">// 检查请求传入参数的类型是否为指针类型，如果不是，则使用 Addr() 方法将 req.argv 转换为指针类型</span><br>    <span class="hljs-comment">// 为什么？</span><br>    <span class="hljs-comment">// 因为如果传入值是值类型，传入后，是值拷贝，不会修改传入变量的原值，所以需要使用 Addr() 获取地址后传入。</span><br>    argvi := req.argv.Interface() <span class="hljs-comment">// 使用 interface() 方法将 req.argv 转换为 interface&#123;&#125; 类型，这样可以传入任意类型的参数</span><br>    <span class="hljs-keyword">if</span> req.argv.Type().Kind() != reflect.Ptr &#123;<br>        argvi = req.argv.Addr().Interface()<br>    &#125;<br><br>    <span class="hljs-comment">// ReadBody 方法会将请求参数解码到 argvi 中储存</span><br>    <span class="hljs-keyword">if</span> err = cc.ReadBody(argvi); err != <span class="hljs-literal">nil</span> &#123;<br>        log.Println(<span class="hljs-string">&quot;rpc server: read body err:&quot;</span>, err)<br>        <span class="hljs-keyword">return</span> req, err<br>    &#125;<br>    <span class="hljs-keyword">return</span> req, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// readRequestHeader 读取请求头：调用 ReadHeader 方法读取请求头，返回请求头结构体</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(server *Server)</span></span> readRequestHeader(cc codec.Codec) (*codec.Header, <span class="hljs-type">error</span>) &#123;<br>    <span class="hljs-keyword">var</span> h codec.Header<br>    <span class="hljs-keyword">if</span> err := cc.ReadHeader(&amp;h); err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">if</span> err != io.EOF &amp;&amp; !errors.Is(err, io.ErrUnexpectedEOF) &#123;<br>            log.Println(<span class="hljs-string">&quot;rpc server: read header error: &quot;</span>, err)<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>    &#125;<br>    <span class="hljs-keyword">return</span> &amp;h, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// invalidRequest is a placeholder for response argv when error occurs</span><br><span class="hljs-keyword">var</span> invalidRequest = <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125;<br><br><span class="hljs-comment">// handleRequest 处理请求：构造请求响应信息，调用 sendResponse 方法发送响应</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(server *Server)</span></span> handleRequest(cc codec.Codec, req *request, sending *sync.Mutex, wg *sync.WaitGroup) &#123;<br>    <span class="hljs-keyword">defer</span> wg.Done()<br><br>    err := req.svc.call(req.mtype, req.argv, req.replyv) <span class="hljs-comment">// 调用</span><br><br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        req.h.Error = err.Error()<br>        server.sendResponse(cc, req.h, invalidRequest, sending)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    server.sendResponse(cc, req.h, req.replyv.Interface(), sending)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(server *Server)</span></span> sendResponse(cc codec.Codec, header *codec.Header, body <span class="hljs-keyword">interface</span>&#123;&#125;, sending *sync.Mutex) &#123;<br>    sending.Lock() <span class="hljs-comment">// 加锁，防止并发写</span><br>    <span class="hljs-keyword">defer</span> sending.Unlock()<br>    <span class="hljs-keyword">if</span> err := cc.Write(header, body); err != <span class="hljs-literal">nil</span> &#123;<br>        log.Println(<span class="hljs-string">&quot;rpc server: write response error: &quot;</span>, err)<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">var</span> DefaultServer = NewServer()<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Register</span><span class="hljs-params">(rcvr <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> <span class="hljs-type">error</span> &#123; <span class="hljs-keyword">return</span> DefaultServer.Register(rcvr) &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(server *Server)</span></span> Register(rcvr <span class="hljs-keyword">interface</span>&#123;&#125;) <span class="hljs-type">error</span> &#123;<br>    s := newService(rcvr)                                        <span class="hljs-comment">// 为 rcvr 变量的类型创建 service 结构体</span><br>    <span class="hljs-keyword">if</span> _, dup := server.serviceMap.LoadOrStore(s.name, s); dup &#123; <span class="hljs-comment">// 调用 serviceMap.LoadOrStore 将 service 结构体保存到 map 中</span><br>        <span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">&quot;rpc: service already defined: &quot;</span> + s.name)<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(server *Server)</span></span> findService(serviceMethod <span class="hljs-type">string</span>) (svc *service, mtype *methodType, err <span class="hljs-type">error</span>) &#123;<br>    dot := strings.LastIndex(serviceMethod, <span class="hljs-string">&quot;.&quot;</span>)<br>    <span class="hljs-keyword">if</span> dot &lt; <span class="hljs-number">0</span> &#123;<br>        err = errors.New(<span class="hljs-string">&quot;rpc server: service/method request ill-formed: &quot;</span> + serviceMethod)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    serviceName, methodName := serviceMethod[:dot], serviceMethod[dot+<span class="hljs-number">1</span>:]<br>    svci, ok := server.serviceMap.Load(serviceName)<br>    <span class="hljs-keyword">if</span> !ok &#123;<br>        err = errors.New(<span class="hljs-string">&quot;rpc server: can&#x27;t find service &quot;</span> + serviceName)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    svc = svci.(*service)<br>    mtype = svc.method[methodName]<br>    <span class="hljs-keyword">if</span> mtype == <span class="hljs-literal">nil</span> &#123;<br>        err = errors.New(<span class="hljs-string">&quot;rpc server: can&#x27;t find method &quot;</span> + methodName)<br>    &#125;<br>    <span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-keyword">var</span> DefaultOption = &amp;Option&#123;<br>    MagicNumber: MagicNumber,<br>    CodecType:   codec.GobType,<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Accept</span><span class="hljs-params">(lis net.Listener)</span></span> &#123;<br>    DefaultServer.Accept(lis)<br>&#125;<br></code></pre></td></tr></table></figure></div></div><div class="fold collapsed"><div class="fold-title">service.go</div><div class="fold-content"><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> geerpc<br><br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;go/ast&quot;</span><br>    <span class="hljs-string">&quot;log&quot;</span><br>    <span class="hljs-string">&quot;reflect&quot;</span><br>    <span class="hljs-string">&quot;sync/atomic&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> methodType <span class="hljs-keyword">struct</span> &#123;<br>    method    reflect.Method <span class="hljs-comment">// 方法本身，用于调用方法，例如 Foo.Sum</span><br>    ArgType   reflect.Type   <span class="hljs-comment">// 参数的类型，用于判断参数是否正确</span><br>    ReplyType reflect.Type   <span class="hljs-comment">// 返回的类型，用于判断返回值是否正确</span><br>    numCalls  <span class="hljs-type">uint64</span>         <span class="hljs-comment">// 方法调用次数，用于统计方法调用次数</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *methodType)</span></span> NumCalls() <span class="hljs-type">uint64</span> &#123;<br>    <span class="hljs-keyword">return</span> atomic.LoadUint64(&amp;m.numCalls)<br>&#125;<br><br><span class="hljs-comment">// newArgv 创建一个参数变量</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *methodType)</span></span> newArgv() reflect.Value &#123;<br>    <span class="hljs-keyword">var</span> argv reflect.Value<br>    <span class="hljs-comment">// 参数可能是指针类型也可能是值类型</span><br>    <span class="hljs-keyword">if</span> m.ArgType.Kind() == reflect.Ptr &#123;<br>        argv = reflect.New(m.ArgType.Elem()) <span class="hljs-comment">// 指针类型，则创建指针类型变量</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        argv = reflect.New(m.ArgType).Elem() <span class="hljs-comment">// 值类型，则创建值类型变量</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> argv<br>&#125;<br><br><span class="hljs-comment">// newReplyv 创建一个传出参数变量</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *methodType)</span></span> newReplyv() reflect.Value &#123;<br>    <span class="hljs-comment">// 传出参数必须是指针类型</span><br>    replyv := reflect.New(m.ReplyType.Elem())<br><br>    <span class="hljs-comment">// 为什么需要对 map 和 slice 特殊处理？</span><br>    <span class="hljs-comment">// reflect.New 创建的 map 和 slice 都是 nil，需要先初始化，再使用。</span><br>    <span class="hljs-keyword">switch</span> m.ReplyType.Elem().Kind() &#123;<br>    <span class="hljs-keyword">case</span> reflect.Map:<br>        replyv.Elem().Set(reflect.MakeMap(m.ReplyType.Elem()))<br>    <span class="hljs-keyword">case</span> reflect.Slice:<br>        replyv.Elem().Set(reflect.MakeSlice(m.ReplyType.Elem(), <span class="hljs-number">0</span>, <span class="hljs-number">0</span>))<br>    &#125;<br>    <span class="hljs-keyword">return</span> replyv<br>&#125;<br><br><span class="hljs-keyword">type</span> service <span class="hljs-keyword">struct</span> &#123;<br>    name   <span class="hljs-type">string</span>                 <span class="hljs-comment">// 变量类型名，用来打 log，例如字符串 &quot;Foo&quot;</span><br>    typ    reflect.Type           <span class="hljs-comment">// 变量类型，通过变量的类型，可以直接获取变量的方法，例如 Foo 类型，可获取到方法 Sum</span><br>    rcvr   reflect.Value          <span class="hljs-comment">// 变量的值，通过变量的值，可以调用变量的方法，例如 &amp;foo，调用 Sum</span><br>    method <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]*methodType <span class="hljs-comment">//  map 储存变量的方法中所有可调用的方法</span><br>&#125;<br><br><span class="hljs-comment">// newService 通过发射获取 rcvr 变量的类型及其方法</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">newService</span><span class="hljs-params">(rcvr <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> *service &#123;<br>    s := <span class="hljs-built_in">new</span>(service)<br>    s.rcvr = reflect.ValueOf(rcvr)                  <span class="hljs-comment">// 获取 rcvr 变量的值，例如 &amp;foo</span><br>    s.name = reflect.Indirect(s.rcvr).Type().Name() <span class="hljs-comment">// 获取 rcvr 变量的类型名，例如 &quot;Foo&quot;</span><br>    s.typ = reflect.TypeOf(rcvr)                    <span class="hljs-comment">// 获取 rcvr 变量的类型，例如 Foo</span><br>    <span class="hljs-keyword">if</span> !ast.IsExported(s.name) &#123;<br>        log.Fatalf(<span class="hljs-string">&quot;rpc server: %s is not a valid service name&quot;</span>, s.name)<br>    &#125;<br>    s.registerMethods() <span class="hljs-comment">// 获取 rcvr 变量的方法列表，例如 Foo.Sum，并将其保存到 service 的方法 map 中</span><br>    <span class="hljs-keyword">return</span> s<br>&#125;<br><br><span class="hljs-comment">// registerMethods 获取 rcvr 变量的方法列表，例如 Foo.Sum，并将其保存到 service 的方法 map 中</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *service)</span></span> registerMethods() &#123;<br>    s.method = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]*methodType)<br><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; s.typ.NumMethod(); i++ &#123; <span class="hljs-comment">// 遍历 rcvr 变量的方法列表</span><br>        method := s.typ.Method(i) <span class="hljs-comment">// 获取 rcvr 变量，第 i 个方法</span><br>        mType := method.Type      <span class="hljs-comment">// 获取 rcvr 变量的方法的类型</span><br><br>        <span class="hljs-comment">// 检查方法的参数是否正确。rpc 的方法必须满足以下条件：</span><br>        <span class="hljs-comment">// 1. 方法有 3 个参数，第 1 个参数是 rcvr 变量(相当于 python 的 self，java 的 this)，第 2 个参数是传入参数，第 3 个参数是传出参数，指针类型</span><br>        <span class="hljs-comment">// 2. 第 2 个参数和第 3 个参数都是导出的类型</span><br>        <span class="hljs-comment">// 3. 返回值只有一个，是 error 类型</span><br>        <span class="hljs-comment">// 例如这样 func (t *T) MethodName(argType T1, replyType *T2) error</span><br>        <span class="hljs-keyword">if</span> mType.NumIn() != <span class="hljs-number">3</span> || mType.NumOut() != <span class="hljs-number">1</span> &#123; <span class="hljs-comment">// 检查参数个数</span><br>            <span class="hljs-keyword">continue</span><br>        &#125;<br>        <span class="hljs-keyword">if</span> mType.Out(<span class="hljs-number">0</span>) != reflect.TypeOf((*<span class="hljs-type">error</span>)(<span class="hljs-literal">nil</span>)).Elem() &#123; <span class="hljs-comment">// 检测返回值个数和类型</span><br>            <span class="hljs-keyword">continue</span><br>        &#125;<br>        argType, replyType := mType.In(<span class="hljs-number">1</span>), mType.In(<span class="hljs-number">2</span>)<br>        <span class="hljs-keyword">if</span> !isExportedOrBuiltinType(argType) || !isExportedOrBuiltinType(replyType) &#123; <span class="hljs-comment">// 检查参数类型是否是导出的类型或者内置类型</span><br>            <span class="hljs-keyword">continue</span><br>        &#125;<br><br>        <span class="hljs-comment">// 检查完毕，将方法保存到 service 的方法 map 中</span><br>        s.method[method.Name] = &amp;methodType&#123;<br>            method:    method,<br>            ArgType:   argType,<br>            ReplyType: replyType,<br>        &#125;<br>        log.Printf(<span class="hljs-string">&quot;rpc server: register %s.%s\n&quot;</span>, s.name, method.Name)<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// isExportedOrBuiltinType 检查类型是否是导出的类型或者内置类型</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">isExportedOrBuiltinType</span><span class="hljs-params">(t reflect.Type)</span></span> <span class="hljs-type">bool</span> &#123;<br>    <span class="hljs-keyword">return</span> ast.IsExported(t.Name()) || t.PkgPath() == <span class="hljs-string">&quot;&quot;</span><br>&#125;<br><br><span class="hljs-comment">// call 调用 rcvr 变量的方法，例如 Foo.Sum</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *service)</span></span> call(m *methodType, argv, replyv reflect.Value) <span class="hljs-type">error</span> &#123;<br>    atomic.AddUint64(&amp;m.numCalls, <span class="hljs-number">1</span>)<br>    f := m.method.Func<br>    <span class="hljs-comment">// 用反射的方式调用方法</span><br>    <span class="hljs-comment">// 第一个参数是 rcvr 变量，例如 &amp;foo，类似于 java 的 this，python 的 self</span><br>    <span class="hljs-comment">// 第 2 个参数是传入参数，第 3 个参数是传出参数，指针类型</span><br>    returnValues := f.Call([]reflect.Value&#123;s.rcvr, argv, replyv&#125;)<br>    <span class="hljs-keyword">if</span> errInter := returnValues[<span class="hljs-number">0</span>].Interface(); errInter != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> errInter.(<span class="hljs-type">error</span>)<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure></div></div><div class="fold collapsed"><div class="fold-title">service_test.go</div><div class="fold-content"><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> geerpc<br><br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;reflect&quot;</span><br>    <span class="hljs-string">&quot;testing&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> Foo <span class="hljs-type">int</span><br><br><span class="hljs-keyword">type</span> Args <span class="hljs-keyword">struct</span>&#123; Num1, Num2 <span class="hljs-type">int</span> &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f Foo)</span></span> Sum(args Args, reply *<span class="hljs-type">int</span>) <span class="hljs-type">error</span> &#123;<br>    *reply = args.Num1 + args.Num2<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// it&#x27;s not a exported Method</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f Foo)</span></span> sum(args Args, reply *<span class="hljs-type">int</span>) <span class="hljs-type">error</span> &#123;<br>    *reply = args.Num1 + args.Num2<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> _<span class="hljs-title">assert</span><span class="hljs-params">(condition <span class="hljs-type">bool</span>, msg <span class="hljs-type">string</span>, v ...<span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;<br>    <span class="hljs-keyword">if</span> !condition &#123;<br>        <span class="hljs-built_in">panic</span>(fmt.Sprintf(<span class="hljs-string">&quot;assertion failed: &quot;</span>+msg, v...))<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestNewService</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>    <span class="hljs-keyword">var</span> foo Foo<br>    s := newService(&amp;foo)<br>    _assert(<span class="hljs-built_in">len</span>(s.method) == <span class="hljs-number">1</span>, <span class="hljs-string">&quot;wrong service Method, expect 1, but got %d&quot;</span>, <span class="hljs-built_in">len</span>(s.method))<br>    mType := s.method[<span class="hljs-string">&quot;Sum&quot;</span>]<br>    _assert(mType != <span class="hljs-literal">nil</span>, <span class="hljs-string">&quot;wrong Method, Sum shouldn&#x27;t nil&quot;</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestMethodType_Call</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>    <span class="hljs-keyword">var</span> foo Foo<br>    s := newService(&amp;foo)<br>    mType := s.method[<span class="hljs-string">&quot;Sum&quot;</span>]<br><br>    argv := mType.newArgv()<br>    replyv := mType.newReplyv()<br>    argv.Set(reflect.ValueOf(Args&#123;Num1: <span class="hljs-number">1</span>, Num2: <span class="hljs-number">3</span>&#125;))<br>    err := s.call(mType, argv, replyv)<br>    _assert(err == <span class="hljs-literal">nil</span> &amp;&amp; *replyv.Interface().(*<span class="hljs-type">int</span>) == <span class="hljs-number">4</span> &amp;&amp; mType.NumCalls() == <span class="hljs-number">1</span>, <span class="hljs-string">&quot;failed to call Foo.Sum&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure></div></div><h2 id="4-超时处理">4.超时处理</h2><h3 id="哪些地方需要超时处理">哪些地方需要超时处理</h3><p>简单来看整个流程：</p><ul><li><p>客户端：</p><ol><li><p>拨号连接 ✓</p></li><li><p>远程调用（发送数据）✓</p></li><li><p>等待服务端处理 ✓</p></li><li><p>接收返回的结果（接收数据）✓</p></li></ol></li><li><p>服务端：</p><ol><li><p>端口监听</p></li><li><p>接收请求信息（接收数据）✓</p></li><li><p>调用方法处理请求信息（处理数据）✓</p></li><li><p>返回请求结果（发送数据）✓</p></li></ol></li></ul><p>以上打 ✓ 的步骤，均可能出现超时，主要为，</p><ul><li>客户端建立连接超时</li><li>发送数据<ul><li>客户端/服务端写报文时超时</li></ul></li><li>处理数据<ul><li>服务端调用方法超时</li></ul></li><li>接收数据<ul><li>客户端等待服务端响应超时</li><li>客户端/服务端读取报文超时</li></ul></li></ul><p>基于这个超时的情景，我们可以在以下三个地方设置超时处理机制。</p><p>客户端：</p><ul><li>建立连接</li><li><code>Client.call()</code> 的整个过程（包含发送数据、等待处理、接收数据）</li></ul><p>服务端：</p><ul><li><code>Server.handleRequest()</code> 的整个过程（包括接收数据、处理数据、发送数据）</li></ul><h3 id="建立连接的超时处理">建立连接的超时处理</h3><p>启动一个 goroutine 来拨号建立连接，使用 select 设置超时器，阻塞等待拨号结果，如果在接收拨号结果之前，先收到了超时信号，则进行超时处理。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// client.go</span><br><span class="hljs-keyword">type</span> NewClientFunc <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(conn net.Conn, opt *Option)</span></span> (*Client, <span class="hljs-type">error</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Dial</span><span class="hljs-params">(network, address <span class="hljs-type">string</span>, opts ...*Option)</span></span> (client *Client, err <span class="hljs-type">error</span>) &#123;<br>    <span class="hljs-keyword">return</span> dialTimeout(NewClient, network, address, opts...)<br>&#125;<br><br><span class="hljs-keyword">type</span> dialResult <span class="hljs-keyword">struct</span> &#123;<br>    client *Client<br>    err    <span class="hljs-type">error</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">dialTimeout</span><span class="hljs-params">(f NewClientFunc, network, address <span class="hljs-type">string</span>, opts ...*Option)</span></span> (client *Client, err <span class="hljs-type">error</span>) &#123;<br>    <span class="hljs-comment">// 默认使用 Gob 编码</span><br>    opt, err := parseOptions(opts...)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>    &#125;<br><br>    <span class="hljs-comment">// 声明一个通道，用于传输拨号建立连接的结果</span><br>    result := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> dialResult, <span class="hljs-number">1</span>) <span class="hljs-comment">// 设置缓冲区为 1，防止在超时后，无人接收 channel 数据，导致 channel 发送时阻塞，导致 goroutine 泄漏</span><br><br>    <span class="hljs-comment">// 当发生错误时，保证 client 为 nil</span><br>    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            client = <span class="hljs-literal">nil</span><br>        &#125;<br>    &#125;()<br><br>    <span class="hljs-comment">// 启动一个 goroutine 连接服务器，连接成功后，调用 f 创建 Client 实例，并将结果发送到 result 通道中</span><br>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>        conn, err := net.DialTimeout(network, address, opt.ConnectTimeout)<br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            result &lt;- dialResult&#123;client: <span class="hljs-literal">nil</span>, err: err&#125;<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        client, err = f(conn, opt)<br>        result &lt;- dialResult&#123;client: client, err: err&#125;<br>    &#125;()<br><br>    <span class="hljs-comment">// 如果超时时间为 0，表示没限制，直接等待 result 通道返回结果</span><br>    <span class="hljs-keyword">if</span> opt.ConnectTimeout == <span class="hljs-number">0</span> &#123;<br>        result := &lt;-result<br>        <span class="hljs-keyword">return</span> result.client, result.err<br>    &#125;<br><br>    <span class="hljs-comment">// 超时处理，阻塞等待，等待超时或收到结果</span><br>    <span class="hljs-keyword">select</span> &#123;<br>    <span class="hljs-keyword">case</span> &lt;-time.After(opt.ConnectTimeout):<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;rpc client: connect timeout: %v&quot;</span>, opt.ConnectTimeout)<br>    <span class="hljs-keyword">case</span> result := &lt;-result:<br>        <span class="hljs-keyword">return</span> result.client, result.err<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>超时的时长，设置在 Option struct 内，便于用户自定义。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// server.go</span><br><br><span class="hljs-comment">// Option 定义 Option 结构体，封装了 MagicNumber 和 CodecType 字段，从 conn 中解析出 Option 的信息，表示 RPC 消息的编码方式</span><br><span class="hljs-keyword">type</span> Option <span class="hljs-keyword">struct</span> &#123;<br>    MagicNumber    <span class="hljs-type">int</span><br>    CodecType      codec.Type<br>    ConnectTimeout time.Duration <span class="hljs-comment">// Client 建立连接的超时时间</span><br>    HandleTimeout  time.Duration <span class="hljs-comment">// Client.Call() 整个过程的超时时间</span><br>&#125;<br><br><span class="hljs-keyword">var</span> DefaultOption = &amp;Option&#123;<br>    MagicNumber:    MagicNumber,<br>    CodecType:      codec.GobType,<br>    ConnectTimeout: time.Second * <span class="hljs-number">10</span>,<br>    <span class="hljs-comment">//HandleTimeout:  time.Second * 10,  // 默认为 0，不设置超时时间</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Call-的超时处理">Call 的超时处理</h3><p>把选择权交给用户。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// client.go</span><br><br><span class="hljs-comment">// Call 同步调用，阻塞等待响应结果</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(client *Client)</span></span> Call(ctx context.Context, serviceMethod <span class="hljs-type">string</span>, args, reply <span class="hljs-keyword">interface</span>&#123;&#125;) <span class="hljs-type">error</span> &#123;<br>    call := client.Go(serviceMethod, args, reply, <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *Call, <span class="hljs-number">1</span>))<br><br>    <span class="hljs-comment">// 等待响应结果/超时</span><br>    <span class="hljs-keyword">select</span> &#123;<br>    <span class="hljs-keyword">case</span> &lt;-ctx.Done():<br>        client.removeCall(call.Seq)<br>        <span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">&quot;rpc client: call failed: &quot;</span> + ctx.Err().Error())<br>    <span class="hljs-keyword">case</span> call := &lt;-call.Done:<br>        <span class="hljs-keyword">return</span> call.Error<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>用户如何使用？</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">ctx, _ := context.WithTimeout(context.Background(), time.Second)<br><span class="hljs-keyword">var</span> reply <span class="hljs-type">int</span><br>err := client.Call(ctx, <span class="hljs-string">&quot;Foo.Sum&quot;</span>, &amp;Args&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>&#125;, &amp;reply)<br></code></pre></td></tr></table></figure><h3 id="handleRequest-超时处理">handleRequest 超时处理</h3><p>这里先不管读取数据了，仅对 handleRequest 做超时处理。handleRequest 其中又分为两个步骤，处理数据、发送数据，仅对处理数据做超时处理。</p><p>设置两个 channel，一个表示 <code>req.svc.call</code> 完成，一个表示 <code>server.sendResponse</code> 完成。当 <code>req.svc.call</code> 完成后，就不用管超时时间是否到达，继续让 server.sendResponse 发送数据。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// server.go</span><br><br><span class="hljs-comment">// handleRequest 处理请求：构造请求响应信息，调用 sendResponse 方法发送响应</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(server *Server)</span></span> handleRequest(cc codec.Codec, req *request, sending *sync.Mutex, wg *sync.WaitGroup, timeout time.Duration) &#123;<br>    <span class="hljs-keyword">defer</span> wg.Done()<br><br>    called := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;, <span class="hljs-number">1</span>) <span class="hljs-comment">// 设置缓冲区为 1，防止在超时后，无人接收 channel 数据，导致 channel 发送时阻塞，导致 goroutine 泄漏</span><br>    sent := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;, <span class="hljs-number">1</span>)   <span class="hljs-comment">// 设置缓冲区为 1，防止在超时后，无人接收 channel 数据，导致 channel 发送时阻塞，导致 goroutine 泄漏</span><br><br><br>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>        err := req.svc.call(req.mtype, req.argv, req.replyv) <span class="hljs-comment">// 调用</span><br>        called &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125;  <span class="hljs-comment">// 调用完成, 不管是否超时，继续发送数据</span><br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            req.h.Error = err.Error()<br>            server.sendResponse(cc, req.h, invalidRequest, sending)<br>            sent &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125;<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        server.sendResponse(cc, req.h, req.replyv.Interface(), sending)<br>        sent &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125;<br>    &#125;()<br><br>    <span class="hljs-keyword">if</span> timeout == <span class="hljs-number">0</span> &#123; <span class="hljs-comment">// 没有超时时间，直接等待</span><br>        &lt;-called<br>        &lt;-sent<br>        <span class="hljs-keyword">return</span><br>    &#125;<br><br>    <span class="hljs-comment">// 有超时时间，使用 select 等待超时或调用完成</span><br>    <span class="hljs-keyword">select</span> &#123;<br>    <span class="hljs-keyword">case</span> &lt;-time.After(timeout):<br>        server.sendResponse(cc, req.h, invalidRequest, sending)<br>    <span class="hljs-keyword">case</span> &lt;-called: <span class="hljs-comment">// 如果调用完成，则不管超时时间，等待 sent（仅对 req.svc.call 做超时处理）</span><br>        &lt;-sent<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="测试代码">测试代码</h3><p>测试客户端处理连接超时的情况</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// client_test.go</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestClient_dialTimeout</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>    t.Parallel() <span class="hljs-comment">// 设置测试项并行执行</span><br><br>    f := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(conn net.Conn, opt *Option)</span></span> (client *Client, err <span class="hljs-type">error</span>) &#123;<br>        _ = conn.Close()<br>        time.Sleep(time.Second * <span class="hljs-number">2</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span> <span class="hljs-comment">// 模拟了一个没有错误的客户端连接</span><br>    &#125;<br><br>    l, _ := net.Listen(<span class="hljs-string">&quot;tcp&quot;</span>, <span class="hljs-string">&quot;:0&quot;</span>)<br><br>    <span class="hljs-comment">// 测试客户端连接有超时处理的情况</span><br>    t.Run(<span class="hljs-string">&quot;connect timeout&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>        _, err := dialTimeout(f, <span class="hljs-string">&quot;tcp&quot;</span>, l.Addr().String(), &amp;Option&#123;ConnectTimeout: time.Second&#125;)<br>        _assert(err != <span class="hljs-literal">nil</span> &amp;&amp; strings.Contains(err.Error(), <span class="hljs-string">&quot;connect timeout&quot;</span>), <span class="hljs-string">&quot;expect a timeout error&quot;</span>)<br>    &#125;)<br><br>    <span class="hljs-comment">// 测试客户端连接没有超时处理的情况</span><br>    t.Run(<span class="hljs-string">&quot;0&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>        _, err := dialTimeout(f, <span class="hljs-string">&quot;tcp&quot;</span>, l.Addr().String(), &amp;Option&#123;ConnectTimeout: <span class="hljs-number">0</span>&#125;)<br>        _assert(err == <span class="hljs-literal">nil</span>, <span class="hljs-string">&quot;0 means no limit&quot;</span>)<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure><p>测试客户端处理调用超时和服务端处理超时的情况</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// server_test.go</span><br><span class="hljs-keyword">type</span> ServiceTemp <span class="hljs-type">int</span><br><br><span class="hljs-comment">// ServiceTemp 有一个方法 Timeout，该方法耗时2s</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s ServiceTemp)</span></span> Timeout(args <span class="hljs-type">int</span>, reply *<span class="hljs-type">int</span>) <span class="hljs-type">error</span> &#123;<br>    time.Sleep(time.Second * time.Duration(args))<br>    *reply = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestClient_Call</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>    t.Parallel()<br><br>    addrCh := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">string</span>)<br>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(<span class="hljs-keyword">chan</span> <span class="hljs-type">string</span>)</span></span> &#123; <span class="hljs-comment">// 启动一个服务器，监听 0 端口，注册 ServiceTemp 类型的对象，然后启动 Accept 方法，等待客户端连接</span><br>        <span class="hljs-keyword">var</span> s ServiceTemp<br>        _ = Register(&amp;s)<br>        l, _ := net.Listen(<span class="hljs-string">&quot;tcp&quot;</span>, <span class="hljs-string">&quot;:0&quot;</span>)<br>        addrCh &lt;- l.Addr().String()<br>        Accept(l)<br>    &#125;(addrCh)<br>    addr := &lt;-addrCh<br><br>    <span class="hljs-comment">// 测试客户端处理调用超时的情况</span><br>    t.Run(<span class="hljs-string">&quot;client call timeout&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>        client, _ := Dial(<span class="hljs-string">&quot;tcp&quot;</span>, addr)<br><br>        ctx, _ := context.WithTimeout(context.Background(), time.Second) <span class="hljs-comment">// 创建一个超时的 context，如果 1s 内没有返回结果，context.Done() 会传出信号 struct&#123;&#125;&#123;&#125;</span><br>        <span class="hljs-keyword">var</span> reply <span class="hljs-type">int</span><br>        err := client.Call(ctx, <span class="hljs-string">&quot;ServiceTemp.Timeout&quot;</span>, <span class="hljs-number">20</span>, &amp;reply) <span class="hljs-comment">// 调用 ServiceTemp.Timeout 方法，Call 发生超时</span><br>        _assert(err != <span class="hljs-literal">nil</span> &amp;&amp; strings.Contains(err.Error(), ctx.Err().Error()), <span class="hljs-string">&quot;expect a timeout error&quot;</span>)<br>    &#125;)<br><br>    <span class="hljs-comment">// 测试服务端处理超时的情况</span><br>    t.Run(<span class="hljs-string">&quot;server handle timeout&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>        client, _ := Dial(<span class="hljs-string">&quot;tcp&quot;</span>, addr, &amp;Option&#123;HandleTimeout: time.Second&#125;)<br>        <span class="hljs-keyword">var</span> reply <span class="hljs-type">int</span><br>        err := client.Call(context.Background(), <span class="hljs-string">&quot;ServiceTemp.Timeout&quot;</span>, <span class="hljs-number">20</span>, &amp;reply) <span class="hljs-comment">// 调用 ServiceTemp.Timeout 方法，服务端处理超时</span><br>        _assert(err != <span class="hljs-literal">nil</span> &amp;&amp; strings.Contains(err.Error(), <span class="hljs-string">&quot;handle timeout&quot;</span>), <span class="hljs-string">&quot;expect a timeout error&quot;</span>)<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="完整代码-2">完整代码</h3><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs maxima"># 代码结构<br>version_4_timeout<br>├── client.<span class="hljs-built_in">go</span> (改动)<br>├── client_test.<span class="hljs-built_in">go</span> (改动)<br>├── codec<br>│   ├── codec.<span class="hljs-built_in">go</span><br>│   └── gob.<span class="hljs-built_in">go</span><br>├── <span class="hljs-built_in">go</span>.<span class="hljs-built_in">mod</span><br>├── main<br>│   └── main.<span class="hljs-built_in">go</span><br>├── server.<span class="hljs-built_in">go</span><br>├── service.<span class="hljs-built_in">go</span> (改动)<br>└── service_test.<span class="hljs-built_in">go</span> (改动)<br></code></pre></td></tr></table></figure><div class="fold collapsed"><div class="fold-title">server.go</div><div class="fold-content"><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> geerpc<br><br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;encoding/json&quot;</span><br>    <span class="hljs-string">&quot;errors&quot;</span><br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;geerpc/codec&quot;</span><br>    <span class="hljs-string">&quot;io&quot;</span><br>    <span class="hljs-string">&quot;log&quot;</span><br>    <span class="hljs-string">&quot;net&quot;</span><br>    <span class="hljs-string">&quot;reflect&quot;</span><br>    <span class="hljs-string">&quot;strings&quot;</span><br>    <span class="hljs-string">&quot;sync&quot;</span><br>    <span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-keyword">const</span> MagicNumber = <span class="hljs-number">0x3bef5c</span><br><br><span class="hljs-comment">// Option 定义 Option 结构体，封装了 MagicNumber 和 CodecType 字段，从 conn 中解析出 Option 的信息，表示 RPC 消息的编码方式</span><br><span class="hljs-keyword">type</span> Option <span class="hljs-keyword">struct</span> &#123;<br>    MagicNumber    <span class="hljs-type">int</span><br>    CodecType      codec.Type<br>    ConnectTimeout time.Duration <span class="hljs-comment">// Client 建立连接的超时时间</span><br>    HandleTimeout  time.Duration <span class="hljs-comment">// Client.Call() 整个过程的超时时间</span><br>&#125;<br><br><span class="hljs-comment">// Server 定义 Server 结构体，封装了 Accept、ServeConn、serveCodec 方法</span><br><span class="hljs-keyword">type</span> Server <span class="hljs-keyword">struct</span> &#123;<br>    serviceMap sync.Map<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewServer</span><span class="hljs-params">()</span></span> *Server &#123;<br>    <span class="hljs-keyword">return</span> &amp;Server&#123;&#125;<br>&#125;<br><br><span class="hljs-comment">// Accept 处理连接：建立 socket 连接，使用 goroutine 处理连接</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(server *Server)</span></span> Accept(lis net.Listener) &#123;<br>    <span class="hljs-keyword">for</span> &#123;<br>        conn, err := lis.Accept() <span class="hljs-comment">// 建立 socket 连接</span><br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            log.Println(<span class="hljs-string">&quot;rpc server: accept error: &quot;</span>, err)<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-keyword">go</span> server.ServeConn(conn) <span class="hljs-comment">// 使用 goroutine 处理连接</span><br>    &#125;<br><br>&#125;<br><br><span class="hljs-comment">// ServeConn 处理消息：解析出 Option 信息，根据 CodecType 选择对应的 codec，调用 serveCodec 方法处理剩下的消息</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(server *Server)</span></span> ServeConn(conn io.ReadWriteCloser) &#123;<br><br>    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>        _ = conn.Close()<br>    &#125;()<br><br>    <span class="hljs-keyword">var</span> opt Option<br>    <span class="hljs-keyword">if</span> err := json.NewDecoder(conn).Decode(&amp;opt); err != <span class="hljs-literal">nil</span> &#123; <span class="hljs-comment">// opt 是传出参数，读到 RPC 前面的 JSON 数据，这包含了 option 信息，表示 RPC 消息的编码方式</span><br>        log.Println(<span class="hljs-string">&quot;rpc server: options error: &quot;</span>, err)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    <span class="hljs-keyword">if</span> opt.MagicNumber != MagicNumber &#123;<br>        log.Printf(<span class="hljs-string">&quot;rpc server: invalid magic number %x&quot;</span>, opt.MagicNumber)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    f := codec.NewCodecFuncMap[opt.CodecType]<br>    <span class="hljs-keyword">if</span> f == <span class="hljs-literal">nil</span> &#123;<br>        log.Printf(<span class="hljs-string">&quot;rpc server: invalid codec type %s&quot;</span>, opt.CodecType)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    server.serveCodec(f(conn), &amp;opt)<br>&#125;<br><br><span class="hljs-comment">// serveCodec 处理请求：调用 readRequest 方法读取请求，调用 handleRequest 方法处理请求</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(server *Server)</span></span> serveCodec(cc codec.Codec, opt *Option) &#123;<br>    sending := <span class="hljs-built_in">new</span>(sync.Mutex)<br>    wg := <span class="hljs-built_in">new</span>(sync.WaitGroup)<br><br>    <span class="hljs-keyword">for</span> &#123;<br>        req, err := server.readRequest(cc)<br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            <span class="hljs-keyword">break</span><br>        &#125;<br><br>        wg.Add(<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">go</span> server.handleRequest(cc, req, sending, wg, opt.HandleTimeout)<br>    &#125;<br>    wg.Wait()<br>    _ = cc.Close()<br>&#125;<br><br><span class="hljs-comment">// request 表示一次调用的所有信息</span><br><span class="hljs-keyword">type</span> request <span class="hljs-keyword">struct</span> &#123;<br>    h            *codec.Header <span class="hljs-comment">// 请求头</span><br>    svc          *service      <span class="hljs-comment">// 请求对应的服务，使用 svc.call 调用对应的方法</span><br>    mtype        *methodType   <span class="hljs-comment">// 请求对应的方法，是 svc.call 的第一个参数</span><br>    argv, replyv reflect.Value <span class="hljs-comment">// 方法的传入参数和传出参数，是 svc.call 的第二个和第三个参数</span><br>&#125;<br><br><span class="hljs-comment">// readRequest 读取请求：调用 readRequestHeader 方法读取请求头，调用 ReadBody 方法读取请求参数，返回 request 结构体</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(server *Server)</span></span> readRequest(cc codec.Codec) (*request, <span class="hljs-type">error</span>) &#123;<br>    <span class="hljs-comment">// 读取请求头</span><br>    h, err := server.readRequestHeader(cc)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>    &#125;<br><br>    <span class="hljs-comment">// 初始化请求结构体</span><br>    req := &amp;request&#123;h: h&#125;<br><br>    <span class="hljs-comment">// 根据请求头中的 ServiceMethod 字段找到对应的服务和方法类型</span><br>    req.svc, req.mtype, err = server.findService(h.ServiceMethod)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> req, err<br>    &#125;<br><br>    <span class="hljs-comment">// 创建传入参数和传出参数的反射对象</span><br>    req.argv = req.mtype.newArgv()<br>    req.replyv = req.mtype.newReplyv()<br><br>    <span class="hljs-comment">// 检查请求传入参数的类型是否为指针类型，如果不是，则使用 Addr() 方法将 req.argv 转换为指针类型</span><br>    <span class="hljs-comment">// 为什么？</span><br>    <span class="hljs-comment">// 因为如果传入值是值类型，传入后，是值拷贝，不会修改传入变量的原值，所以需要使用 Addr() 获取地址后传入。</span><br>    argvi := req.argv.Interface() <span class="hljs-comment">// 使用 interface() 方法将 req.argv 转换为 interface&#123;&#125; 类型，这样可以传入任意类型的参数</span><br>    <span class="hljs-keyword">if</span> req.argv.Type().Kind() != reflect.Ptr &#123;<br>        argvi = req.argv.Addr().Interface()<br>    &#125;<br><br>    <span class="hljs-comment">// ReadBody 方法会将请求参数解码到 argvi 中储存</span><br>    <span class="hljs-keyword">if</span> err = cc.ReadBody(argvi); err != <span class="hljs-literal">nil</span> &#123;<br>        log.Println(<span class="hljs-string">&quot;rpc server: read body err:&quot;</span>, err)<br>        <span class="hljs-keyword">return</span> req, err<br>    &#125;<br>    <span class="hljs-keyword">return</span> req, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// readRequestHeader 读取请求头：调用 ReadHeader 方法读取请求头，返回请求头结构体</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(server *Server)</span></span> readRequestHeader(cc codec.Codec) (*codec.Header, <span class="hljs-type">error</span>) &#123;<br>    <span class="hljs-keyword">var</span> h codec.Header<br>    <span class="hljs-keyword">if</span> err := cc.ReadHeader(&amp;h); err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">if</span> err != io.EOF &amp;&amp; !errors.Is(err, io.ErrUnexpectedEOF) &#123;<br>            log.Println(<span class="hljs-string">&quot;rpc server: read header error: &quot;</span>, err)<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>    &#125;<br>    <span class="hljs-keyword">return</span> &amp;h, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// invalidRequest is a placeholder for response argv when error occurs</span><br><span class="hljs-keyword">var</span> invalidRequest = <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125;<br><br><span class="hljs-comment">// handleRequest 处理请求：构造请求响应信息，调用 sendResponse 方法发送响应</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(server *Server)</span></span> handleRequest(cc codec.Codec, req *request, sending *sync.Mutex, wg *sync.WaitGroup, timeout time.Duration) &#123;<br>    <span class="hljs-keyword">defer</span> wg.Done()<br><br>    called := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;, <span class="hljs-number">1</span>) <span class="hljs-comment">// 设置缓冲区为 1，防止在超时后，无人接收 channel 数据，导致 channel 发送时阻塞，导致 goroutine 泄漏</span><br>    sent := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;, <span class="hljs-number">1</span>)   <span class="hljs-comment">// 设置缓冲区为 1，防止在超时后，无人接收 channel 数据，导致 channel 发送时阻塞，导致 goroutine 泄漏</span><br><br>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>        err := req.svc.call(req.mtype, req.argv, req.replyv) <span class="hljs-comment">// 调用</span><br>        called &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125;                                 <span class="hljs-comment">// 调用完成, 不管是否超时，继续发送数据</span><br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            req.h.Error = err.Error()<br>            server.sendResponse(cc, req.h, invalidRequest, sending)<br>            sent &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125;<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        server.sendResponse(cc, req.h, req.replyv.Interface(), sending)<br>        sent &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125;<br>    &#125;()<br><br>    <span class="hljs-keyword">if</span> timeout == <span class="hljs-number">0</span> &#123; <span class="hljs-comment">// 没有超时时间，直接等待</span><br>        &lt;-called<br>        &lt;-sent<br>        <span class="hljs-keyword">return</span><br>    &#125;<br><br>    <span class="hljs-comment">// 有超时时间，使用 select 等待超时或调用完成</span><br>    <span class="hljs-keyword">select</span> &#123;<br>    <span class="hljs-keyword">case</span> &lt;-time.After(timeout):<br>        req.h.Error = fmt.Sprintf(<span class="hljs-string">&quot;rpc server: request handle timeout: expect within %s&quot;</span>, timeout)<br>        server.sendResponse(cc, req.h, invalidRequest, sending)<br>    <span class="hljs-keyword">case</span> &lt;-called: <span class="hljs-comment">// 如果调用完成，则不管超时时间，等待 sent（仅对 req.svc.call 做超时处理）</span><br>        &lt;-sent<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(server *Server)</span></span> sendResponse(cc codec.Codec, header *codec.Header, body <span class="hljs-keyword">interface</span>&#123;&#125;, sending *sync.Mutex) &#123;<br>    sending.Lock() <span class="hljs-comment">// 加锁，防止并发写</span><br>    <span class="hljs-keyword">defer</span> sending.Unlock()<br>    <span class="hljs-keyword">if</span> err := cc.Write(header, body); err != <span class="hljs-literal">nil</span> &#123;<br>        log.Println(<span class="hljs-string">&quot;rpc server: write response error: &quot;</span>, err)<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">var</span> DefaultServer = NewServer()<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Register</span><span class="hljs-params">(rcvr <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> <span class="hljs-type">error</span> &#123; <span class="hljs-keyword">return</span> DefaultServer.Register(rcvr) &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(server *Server)</span></span> Register(rcvr <span class="hljs-keyword">interface</span>&#123;&#125;) <span class="hljs-type">error</span> &#123;<br>    s := newService(rcvr)                                        <span class="hljs-comment">// 为 rcvr 变量的类型创建 service 结构体</span><br>    <span class="hljs-keyword">if</span> _, dup := server.serviceMap.LoadOrStore(s.name, s); dup &#123; <span class="hljs-comment">// 调用 serviceMap.LoadOrStore 将 service 结构体保存到 map 中</span><br>        <span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">&quot;rpc: service already defined: &quot;</span> + s.name)<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(server *Server)</span></span> findService(serviceMethod <span class="hljs-type">string</span>) (svc *service, mtype *methodType, err <span class="hljs-type">error</span>) &#123;<br>    dot := strings.LastIndex(serviceMethod, <span class="hljs-string">&quot;.&quot;</span>)<br>    <span class="hljs-keyword">if</span> dot &lt; <span class="hljs-number">0</span> &#123;<br>        err = errors.New(<span class="hljs-string">&quot;rpc server: service/method request ill-formed: &quot;</span> + serviceMethod)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    serviceName, methodName := serviceMethod[:dot], serviceMethod[dot+<span class="hljs-number">1</span>:]<br>    svci, ok := server.serviceMap.Load(serviceName)<br>    <span class="hljs-keyword">if</span> !ok &#123;<br>        err = errors.New(<span class="hljs-string">&quot;rpc server: can&#x27;t find service &quot;</span> + serviceName)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    svc = svci.(*service)<br>    mtype = svc.method[methodName]<br>    <span class="hljs-keyword">if</span> mtype == <span class="hljs-literal">nil</span> &#123;<br>        err = errors.New(<span class="hljs-string">&quot;rpc server: can&#x27;t find method &quot;</span> + methodName)<br>    &#125;<br>    <span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-keyword">var</span> DefaultOption = &amp;Option&#123;<br>    MagicNumber:    MagicNumber,<br>    CodecType:      codec.GobType,<br>    ConnectTimeout: time.Second * <span class="hljs-number">10</span>,<br>    <span class="hljs-comment">//HandleTimeout:  time.Second * 10,  // 默认为 0，不设置超时时间</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Accept</span><span class="hljs-params">(lis net.Listener)</span></span> &#123;<br>    DefaultServer.Accept(lis)<br>&#125;<br></code></pre></td></tr></table></figure></div></div><div class="fold collapsed"><div class="fold-title">client.go</div><div class="fold-content"><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> geerpc<br><br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;context&quot;</span><br>    <span class="hljs-string">&quot;encoding/json&quot;</span><br>    <span class="hljs-string">&quot;errors&quot;</span><br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;geerpc/codec&quot;</span><br>    <span class="hljs-string">&quot;log&quot;</span><br>    <span class="hljs-string">&quot;net&quot;</span><br>    <span class="hljs-string">&quot;sync&quot;</span><br>    <span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-comment">// Call 实例表示一次 RPC 调用请求</span><br><span class="hljs-keyword">type</span> Call <span class="hljs-keyword">struct</span> &#123;<br>    Seq           <span class="hljs-type">uint64</span>      <span class="hljs-comment">// 请求的序号</span><br>    ServiceMethod <span class="hljs-type">string</span>      <span class="hljs-comment">// 请求的方法名</span><br>    Args          <span class="hljs-keyword">interface</span>&#123;&#125; <span class="hljs-comment">// 请求的参数</span><br>    Reply         <span class="hljs-keyword">interface</span>&#123;&#125; <span class="hljs-comment">// 请求的响应信息</span><br>    Error         <span class="hljs-type">error</span><br>    Done          <span class="hljs-keyword">chan</span> *Call <span class="hljs-comment">// 当调用结束后，会通过 Done 通知调用者  // 这个写法有意思，channel 的类型是 *Call</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(call *Call)</span></span> done() &#123;<br>    call.Done &lt;- call<br>&#125;<br><br><span class="hljs-comment">// Client 表示一个 RPC 客户端，一个客户端可以完成多个请求（Call 实例）的发送和接收</span><br><span class="hljs-comment">// 管理连接、请求和响应，可同时被多个协程并发使用</span><br><span class="hljs-comment">// 提供 Dial 方法，用于建立连接；提供 Call 方法，用于发送请求并等待响应结果</span><br><span class="hljs-keyword">type</span> Client <span class="hljs-keyword">struct</span> &#123;<br>    cc       codec.Codec      <span class="hljs-comment">// 消息编解码器，用于序列化请求和反序列化响应</span><br>    opt      *Option          <span class="hljs-comment">// 客户端配置，比如编码方式和协议参数。</span><br>    sending  sync.Mutex       <span class="hljs-comment">// 互斥锁，用于确保在同一时间只有一个请求被发送</span><br>    header   codec.Header     <span class="hljs-comment">// 每个请求，共用这个同一消息头</span><br>    mu       sync.Mutex       <span class="hljs-comment">// 互斥锁，保护 pending 和 shutdown 字段，防止并发读写</span><br>    seq      <span class="hljs-type">uint64</span>           <span class="hljs-comment">// 用于给每个请求分配一个编号，用于区分不同的请求。（每个请求间没有顺序要求）</span><br>    pending  <span class="hljs-keyword">map</span>[<span class="hljs-type">uint64</span>]*Call <span class="hljs-comment">// 每个请求对应一个 Call 实例。未处理的请求会被保存在该字段中</span><br>    closing  <span class="hljs-type">bool</span>             <span class="hljs-comment">// 是否正在关闭连接</span><br>    shutdown <span class="hljs-type">bool</span>             <span class="hljs-comment">// 客户端是否已经关闭</span><br>&#125;<br><br><span class="hljs-keyword">var</span> ErrShutdown = errors.New(<span class="hljs-string">&quot;client has been shut down&quot;</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(client *Client)</span></span> Close() <span class="hljs-type">error</span> &#123;<br>    client.mu.Lock()<br>    <span class="hljs-keyword">defer</span> client.mu.Unlock()<br><br>    <span class="hljs-keyword">if</span> client.closing &#123;<br>        <span class="hljs-keyword">return</span> ErrShutdown<br>    &#125;<br>    client.closing = <span class="hljs-literal">true</span><br>    <span class="hljs-keyword">return</span> client.cc.Close()<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(client *Client)</span></span> IsAvailable() <span class="hljs-type">bool</span> &#123;<br>    client.mu.Lock()<br>    <span class="hljs-keyword">defer</span> client.mu.Unlock()<br>    <span class="hljs-keyword">return</span> !client.shutdown &amp;&amp; !client.closing<br>&#125;<br><br><span class="hljs-comment">// registerCall 方法用于注册一个 Call 实例，并返回该实例的序号。</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(client *Client)</span></span> registerCall(call *Call) (<span class="hljs-type">uint64</span>, <span class="hljs-type">error</span>) &#123;<br>    client.mu.Lock()<br>    <span class="hljs-keyword">defer</span> client.mu.Unlock()<br><br>    <span class="hljs-keyword">if</span> client.closing || client.shutdown &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, ErrShutdown<br>    &#125;<br><br>    call.Seq = client.seq<br>    client.pending[call.Seq] = call<br>    client.seq++<br>    <span class="hljs-keyword">return</span> call.Seq, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// removeCall 方法用于从 pending 中移除一个 Call 实例，表示该请求已处理完成或已取消，并返回该实例。</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(client *Client)</span></span> removeCall(seq <span class="hljs-type">uint64</span>) *Call &#123;<br>    client.mu.Lock()<br>    <span class="hljs-keyword">defer</span> client.mu.Unlock()<br><br>    call := client.pending[seq]<br>    <span class="hljs-built_in">delete</span>(client.pending, seq)<br>    <span class="hljs-keyword">return</span> call<br>&#125;<br><br><span class="hljs-comment">// terminateCalls 方法用于在客户端关闭时，终止所有未完成的调用，并通知调用者发生了错误</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(client *Client)</span></span> terminateCalls(err <span class="hljs-type">error</span>) &#123;<br>    client.sending.Lock()<br>    <span class="hljs-keyword">defer</span> client.sending.Unlock()<br><br>    client.mu.Lock()<br>    <span class="hljs-keyword">defer</span> client.mu.Unlock()<br><br>    client.shutdown = <span class="hljs-literal">true</span><br>    <span class="hljs-keyword">for</span> _, call := <span class="hljs-keyword">range</span> client.pending &#123;<br>        call.Error = err<br>        call.done()<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(client *Client)</span></span> receive() &#123;<br>    <span class="hljs-keyword">var</span> err <span class="hljs-type">error</span><br>    <span class="hljs-keyword">for</span> err == <span class="hljs-literal">nil</span> &#123; <span class="hljs-comment">// 这个写法，会在 err 不为 nil 时退出循环，所以只会处理一次错误</span><br>        <span class="hljs-comment">// 读取请求头</span><br>        <span class="hljs-keyword">var</span> h codec.Header<br>        <span class="hljs-keyword">if</span> err = client.cc.ReadHeader(&amp;h); err != <span class="hljs-literal">nil</span> &#123;<br>            <span class="hljs-keyword">break</span><br>        &#125;<br><br>        <span class="hljs-comment">// 根据 h.Seq 找到对应的 Call 实例，并从 pending 中移除。</span><br>        call := client.removeCall(h.Seq)<br><br>        <span class="hljs-comment">// 三种处理响应的情况</span><br>        <span class="hljs-keyword">switch</span> &#123;<br>        <span class="hljs-keyword">case</span> call == <span class="hljs-literal">nil</span>: <span class="hljs-comment">// Call 实例不存在，（可能客户端已经取消请求，但服务器还是在响应请求），忽略该请求</span><br>            err = client.cc.ReadBody(<span class="hljs-literal">nil</span>)<br>        <span class="hljs-keyword">case</span> h.Error != <span class="hljs-string">&quot;&quot;</span>: <span class="hljs-comment">// Call 实例存在，但服务器返回了错误</span><br>            <span class="hljs-comment">// 将错误信息写入 call.Error 中，调用 call.done() 通知调用方</span><br>            call.Error = fmt.Errorf(h.Error)<br>            err = client.cc.ReadBody(<span class="hljs-literal">nil</span>)<br>            call.done()<br>        <span class="hljs-keyword">default</span>: <span class="hljs-comment">// Call 实例存在，服务器正常响应</span><br>            <span class="hljs-comment">// 读取响应体，将响应信息写入 call.Reply 中，调用 call.done() 通知调用方</span><br>            err = client.cc.ReadBody(call.Reply)<br>            <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>                call.Error = errors.New(<span class="hljs-string">&quot;reading body &quot;</span> + err.Error())<br>            &#125;<br>            call.done()<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// 如果发生错误（如连接断开），调用 terminateCalls 方法： 将所有未完成的调用（pending 中的所有调用）标记为错误状态。通知所有调用方，释放资源。</span><br>    client.terminateCalls(err)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewClient</span><span class="hljs-params">(conn net.Conn, opt *Option)</span></span> (*Client, <span class="hljs-type">error</span>) &#123;<br><br>    <span class="hljs-comment">// 用 JSON 数据通知服务器，客户端的编码方式</span><br>    <span class="hljs-comment">// json.NewEncoder(conn) 创建一个 JSON Encoder 对象，Encode 方法将 opt 编码为 JSON 数据， JSON Encoder 对象将 Json 数据写入到 conn 中，也就是发给服务器</span><br>    <span class="hljs-keyword">if</span> err := json.NewEncoder(conn).Encode(opt); err != <span class="hljs-literal">nil</span> &#123;<br>        log.Println(<span class="hljs-string">&quot;rpc client: options error: &quot;</span>, err)<br>        _ = conn.Close()<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>    &#125;<br><br>    newCodecFunc := codec.NewCodecFuncMap[opt.CodecType]<br>    <span class="hljs-keyword">if</span> newCodecFunc == <span class="hljs-literal">nil</span> &#123;<br>        err := fmt.Errorf(<span class="hljs-string">&quot;invalid codec type %s&quot;</span>, opt.CodecType)<br>        log.Println(<span class="hljs-string">&quot;rpc client: codec error:&quot;</span>, err)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>    &#125;<br>    <span class="hljs-keyword">return</span> newClientCodec(newCodecFunc(conn), opt), <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">newClientCodec</span><span class="hljs-params">(cc codec.Codec, opt *Option)</span></span> *Client &#123;<br>    client := &amp;Client&#123;<br>        seq:     <span class="hljs-number">1</span>, <span class="hljs-comment">// seq starts with 1, 0 means invalid call</span><br>        cc:      cc,<br>        opt:     opt,<br>        pending: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">uint64</span>]*Call),<br>    &#125;<br>    <span class="hljs-keyword">go</span> client.receive()<br>    <span class="hljs-keyword">return</span> client<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">parseOptions</span><span class="hljs-params">(opts ...*Option)</span></span> (*Option, <span class="hljs-type">error</span>) &#123;<br>    <span class="hljs-comment">// if opts is nil or pass nil as parameter</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(opts) == <span class="hljs-number">0</span> || opts[<span class="hljs-number">0</span>] == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> DefaultOption, <span class="hljs-literal">nil</span><br>    &#125;<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(opts) != <span class="hljs-number">1</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(<span class="hljs-string">&quot;number of options is more than 1&quot;</span>)<br>    &#125;<br>    opt := opts[<span class="hljs-number">0</span>]<br>    opt.MagicNumber = DefaultOption.MagicNumber<br>    <span class="hljs-keyword">if</span> opt.CodecType == <span class="hljs-string">&quot;&quot;</span> &#123;<br>        opt.CodecType = DefaultOption.CodecType<br>    &#125;<br>    <span class="hljs-keyword">return</span> opt, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-keyword">type</span> NewClientFunc <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(conn net.Conn, opt *Option)</span></span> (*Client, <span class="hljs-type">error</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Dial</span><span class="hljs-params">(network, address <span class="hljs-type">string</span>, opts ...*Option)</span></span> (client *Client, err <span class="hljs-type">error</span>) &#123;<br>    <span class="hljs-keyword">return</span> dialTimeout(NewClient, network, address, opts...)<br>&#125;<br><br><span class="hljs-keyword">type</span> dialResult <span class="hljs-keyword">struct</span> &#123;<br>    client *Client<br>    err    <span class="hljs-type">error</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">dialTimeout</span><span class="hljs-params">(f NewClientFunc, network, address <span class="hljs-type">string</span>, opts ...*Option)</span></span> (client *Client, err <span class="hljs-type">error</span>) &#123;<br>    <span class="hljs-comment">// 默认使用 Gob 编码</span><br>    opt, err := parseOptions(opts...)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>    &#125;<br><br>    <span class="hljs-comment">// 声明一个通道，用于传输拨号建立连接的结果</span><br>    result := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> dialResult, <span class="hljs-number">1</span>) <span class="hljs-comment">// 设置缓冲区为 1，防止在超时后，无人接收 channel 数据，导致 channel 发送时阻塞，导致 goroutine 泄漏</span><br><br>    <span class="hljs-comment">// 当发生错误时，保证 client 为 nil</span><br>    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            client = <span class="hljs-literal">nil</span><br>        &#125;<br>    &#125;()<br><br>    <span class="hljs-comment">// 启动一个 goroutine 连接服务器，连接成功后，调用 f 创建 Client 实例，并将结果发送到 result 通道中</span><br>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>        conn, err := net.DialTimeout(network, address, opt.ConnectTimeout)<br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            result &lt;- dialResult&#123;client: <span class="hljs-literal">nil</span>, err: err&#125;<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        client, err = f(conn, opt)<br>        result &lt;- dialResult&#123;client: client, err: err&#125;<br>    &#125;()<br><br>    <span class="hljs-comment">// 如果超时时间为 0，表示没限制，直接等待 result 通道返回结果</span><br>    <span class="hljs-keyword">if</span> opt.ConnectTimeout == <span class="hljs-number">0</span> &#123;<br>        result := &lt;-result<br>        <span class="hljs-keyword">return</span> result.client, result.err<br>    &#125;<br><br>    <span class="hljs-comment">// 超时处理，阻塞等待，等待超时或收到结果</span><br>    <span class="hljs-keyword">select</span> &#123;<br>    <span class="hljs-keyword">case</span> &lt;-time.After(opt.ConnectTimeout):<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;rpc client: connect timeout: %v&quot;</span>, opt.ConnectTimeout)<br>    <span class="hljs-keyword">case</span> result := &lt;-result:<br>        <span class="hljs-keyword">return</span> result.client, result.err<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// send 发送请求到服务器</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(client *Client)</span></span> send(call *Call) &#123;<br>    <span class="hljs-comment">// make sure that the client will send a complete request</span><br>    client.sending.Lock()<br>    <span class="hljs-keyword">defer</span> client.sending.Unlock()<br><br>    <span class="hljs-comment">// register this call.</span><br>    seq, err := client.registerCall(call)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        call.Error = err<br>        call.done()<br>        <span class="hljs-keyword">return</span><br>    &#125;<br><br>    <span class="hljs-comment">// prepare request header</span><br>    client.header.ServiceMethod = call.ServiceMethod<br>    client.header.Seq = seq<br>    client.header.Error = <span class="hljs-string">&quot;&quot;</span><br><br>    <span class="hljs-comment">// encode and send the request</span><br>    <span class="hljs-keyword">if</span> err := client.cc.Write(&amp;client.header, call.Args); err != <span class="hljs-literal">nil</span> &#123;<br>        call := client.removeCall(seq)<br>        <span class="hljs-comment">// call 可能为 nil</span><br>        <span class="hljs-comment">// 比如由于网络或者某种错误，客户端在 receive() 中已经将该请求从 pending 中移除，此时 call 为 nil</span><br>        <span class="hljs-keyword">if</span> call != <span class="hljs-literal">nil</span> &#123;<br>            call.Error = err<br>            call.done()<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// Go 异步调用，不阻塞等待响应结果</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(client *Client)</span></span> Go(serviceMethod <span class="hljs-type">string</span>, args, reply <span class="hljs-keyword">interface</span>&#123;&#125;, done <span class="hljs-keyword">chan</span> *Call) *Call &#123;<br>    <span class="hljs-keyword">if</span> done == <span class="hljs-literal">nil</span> &#123;<br>        done = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *Call, <span class="hljs-number">10</span>)<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">cap</span>(done) == <span class="hljs-number">0</span> &#123;<br>        log.Panic(<span class="hljs-string">&quot;rpc client: done channel is unbuffered&quot;</span>)<br>    &#125;<br><br>    <span class="hljs-comment">// 为本次调用请求创建一个 Call 实例</span><br>    call := &amp;Call&#123;<br>        ServiceMethod: serviceMethod,<br>        Args:          args,<br>        Reply:         reply,<br>        Done:          done,<br>    &#125;<br><br>    <span class="hljs-comment">// 将 Call 实例发送到客户端</span><br>    client.send(call)<br>    <span class="hljs-keyword">return</span> call<br>&#125;<br><br><span class="hljs-comment">// Call 同步调用，阻塞等待响应结果</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(client *Client)</span></span> Call(ctx context.Context, serviceMethod <span class="hljs-type">string</span>, args, reply <span class="hljs-keyword">interface</span>&#123;&#125;) <span class="hljs-type">error</span> &#123;<br>    call := client.Go(serviceMethod, args, reply, <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *Call, <span class="hljs-number">1</span>))<br><br>    <span class="hljs-comment">// 等待响应结果/超时</span><br>    <span class="hljs-keyword">select</span> &#123;<br>    <span class="hljs-keyword">case</span> &lt;-ctx.Done():<br>        client.removeCall(call.Seq)<br>        <span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">&quot;rpc client: call failed: &quot;</span> + ctx.Err().Error())<br>    <span class="hljs-keyword">case</span> call := &lt;-call.Done:<br>        <span class="hljs-keyword">return</span> call.Error<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></div></div><div class="fold collapsed"><div class="fold-title">server_test.go</div><div class="fold-content"><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> geerpc<br><br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;context&quot;</span><br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;net&quot;</span><br>    <span class="hljs-string">&quot;reflect&quot;</span><br>    <span class="hljs-string">&quot;strings&quot;</span><br>    <span class="hljs-string">&quot;testing&quot;</span><br>    <span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> Foo <span class="hljs-type">int</span><br><br><span class="hljs-keyword">type</span> Args <span class="hljs-keyword">struct</span>&#123; Num1, Num2 <span class="hljs-type">int</span> &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f Foo)</span></span> Sum(args Args, reply *<span class="hljs-type">int</span>) <span class="hljs-type">error</span> &#123;<br>    *reply = args.Num1 + args.Num2<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// it&#x27;s not a exported Method</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f Foo)</span></span> sum(args Args, reply *<span class="hljs-type">int</span>) <span class="hljs-type">error</span> &#123;<br>    *reply = args.Num1 + args.Num2<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> _<span class="hljs-title">assert</span><span class="hljs-params">(condition <span class="hljs-type">bool</span>, msg <span class="hljs-type">string</span>, v ...<span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;<br>    <span class="hljs-keyword">if</span> !condition &#123;<br>        <span class="hljs-built_in">panic</span>(fmt.Sprintf(<span class="hljs-string">&quot;assertion failed: &quot;</span>+msg, v...))<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestNewService</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>    <span class="hljs-keyword">var</span> foo Foo<br>    s := newService(&amp;foo)<br>    _assert(<span class="hljs-built_in">len</span>(s.method) == <span class="hljs-number">1</span>, <span class="hljs-string">&quot;wrong service Method, expect 1, but got %d&quot;</span>, <span class="hljs-built_in">len</span>(s.method))<br>    mType := s.method[<span class="hljs-string">&quot;Sum&quot;</span>]<br>    _assert(mType != <span class="hljs-literal">nil</span>, <span class="hljs-string">&quot;wrong Method, Sum shouldn&#x27;t nil&quot;</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestMethodType_Call</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>    <span class="hljs-keyword">var</span> foo Foo<br>    s := newService(&amp;foo)<br>    mType := s.method[<span class="hljs-string">&quot;Sum&quot;</span>]<br><br>    argv := mType.newArgv()<br>    replyv := mType.newReplyv()<br>    argv.Set(reflect.ValueOf(Args&#123;Num1: <span class="hljs-number">1</span>, Num2: <span class="hljs-number">3</span>&#125;))<br>    err := s.call(mType, argv, replyv)<br>    _assert(err == <span class="hljs-literal">nil</span> &amp;&amp; *replyv.Interface().(*<span class="hljs-type">int</span>) == <span class="hljs-number">4</span> &amp;&amp; mType.NumCalls() == <span class="hljs-number">1</span>, <span class="hljs-string">&quot;failed to call Foo.Sum&quot;</span>)<br>&#125;<br><br><span class="hljs-keyword">type</span> ServiceTemp <span class="hljs-type">int</span><br><br><span class="hljs-comment">// ServiceTemp 有一个方法 Timeout，该方法耗时2s</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s ServiceTemp)</span></span> Timeout(args <span class="hljs-type">int</span>, reply *<span class="hljs-type">int</span>) <span class="hljs-type">error</span> &#123;<br>    time.Sleep(time.Second * time.Duration(args))<br>    *reply = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestClient_Call</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>    t.Parallel()<br><br>    addrCh := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">string</span>)<br>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(<span class="hljs-keyword">chan</span> <span class="hljs-type">string</span>)</span></span> &#123; <span class="hljs-comment">// 启动一个服务器，监听 0 端口，注册 ServiceTemp 类型的对象，然后启动 Accept 方法，等待客户端连接</span><br>        <span class="hljs-keyword">var</span> s ServiceTemp<br>        _ = Register(&amp;s)<br>        l, _ := net.Listen(<span class="hljs-string">&quot;tcp&quot;</span>, <span class="hljs-string">&quot;:0&quot;</span>)<br>        addrCh &lt;- l.Addr().String()<br>        Accept(l)<br>    &#125;(addrCh)<br>    addr := &lt;-addrCh<br><br>    <span class="hljs-comment">// 测试客户端处理调用超时的情况</span><br>    t.Run(<span class="hljs-string">&quot;client call timeout&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>        client, _ := Dial(<span class="hljs-string">&quot;tcp&quot;</span>, addr)<br><br>        ctx, _ := context.WithTimeout(context.Background(), time.Second) <span class="hljs-comment">// 创建一个超时的 context，如果 1s 内没有返回结果，context.Done() 会传出信号 struct&#123;&#125;&#123;&#125;</span><br>        <span class="hljs-keyword">var</span> reply <span class="hljs-type">int</span><br>        err := client.Call(ctx, <span class="hljs-string">&quot;ServiceTemp.Timeout&quot;</span>, <span class="hljs-number">20</span>, &amp;reply) <span class="hljs-comment">// 调用 ServiceTemp.Timeout 方法，Call 发生超时</span><br>        _assert(err != <span class="hljs-literal">nil</span> &amp;&amp; strings.Contains(err.Error(), ctx.Err().Error()), <span class="hljs-string">&quot;expect a timeout error&quot;</span>)<br>    &#125;)<br><br>    <span class="hljs-comment">// 测试服务端处理超时的情况</span><br>    t.Run(<span class="hljs-string">&quot;server handle timeout&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>        client, _ := Dial(<span class="hljs-string">&quot;tcp&quot;</span>, addr, &amp;Option&#123;HandleTimeout: time.Second&#125;)<br>        <span class="hljs-keyword">var</span> reply <span class="hljs-type">int</span><br>        err := client.Call(context.Background(), <span class="hljs-string">&quot;ServiceTemp.Timeout&quot;</span>, <span class="hljs-number">20</span>, &amp;reply) <span class="hljs-comment">// 调用 ServiceTemp.Timeout 方法，服务端处理超时</span><br>        _assert(err != <span class="hljs-literal">nil</span> &amp;&amp; strings.Contains(err.Error(), <span class="hljs-string">&quot;handle timeout&quot;</span>), <span class="hljs-string">&quot;expect a timeout error&quot;</span>)<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure></div></div><div class="fold collapsed"><div class="fold-title">client_test.go</div><div class="fold-content"><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> geerpc<br><br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;net&quot;</span><br>    <span class="hljs-string">&quot;strings&quot;</span><br>    <span class="hljs-string">&quot;testing&quot;</span><br>    <span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestClient_dialTimeout</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>    t.Parallel() <span class="hljs-comment">// 设置测试项并行执行</span><br><br>    f := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(conn net.Conn, opt *Option)</span></span> (client *Client, err <span class="hljs-type">error</span>) &#123;<br>        _ = conn.Close()<br>        time.Sleep(time.Second * <span class="hljs-number">2</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span> <span class="hljs-comment">// 模拟了一个没有错误的客户端连接</span><br>    &#125;<br><br>    l, _ := net.Listen(<span class="hljs-string">&quot;tcp&quot;</span>, <span class="hljs-string">&quot;:0&quot;</span>)<br><br>    <span class="hljs-comment">// 测试客户端连接有超时处理的情况</span><br>    t.Run(<span class="hljs-string">&quot;connect timeout&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>        _, err := dialTimeout(f, <span class="hljs-string">&quot;tcp&quot;</span>, l.Addr().String(), &amp;Option&#123;ConnectTimeout: time.Second&#125;)<br>        _assert(err != <span class="hljs-literal">nil</span> &amp;&amp; strings.Contains(err.Error(), <span class="hljs-string">&quot;connect timeout&quot;</span>), <span class="hljs-string">&quot;expect a timeout error&quot;</span>)<br>    &#125;)<br><br>    <span class="hljs-comment">// 测试客户端连接没有超时处理的情况</span><br>    t.Run(<span class="hljs-string">&quot;0&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>        _, err := dialTimeout(f, <span class="hljs-string">&quot;tcp&quot;</span>, l.Addr().String(), &amp;Option&#123;ConnectTimeout: <span class="hljs-number">0</span>&#125;)<br>        _assert(err == <span class="hljs-literal">nil</span>, <span class="hljs-string">&quot;0 means no limit&quot;</span>)<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure></div></div><h2 id="5-支持-HTTP-协议">5.支持 HTTP 协议</h2><h2 id="6-负载均衡">6.负载均衡</h2><h2 id="7-服务发现与注册中心">7.服务发现与注册中心</h2><script type="text/javascript">!function(l){[].forEach.call(l.getElementsByClassName("fold"),(function(l){l.getElementsByClassName("fold-title")[0].onclick=function(){l.classList.toggle("collapsed"),l.classList.toggle("expanded")}}))}(document)</script></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/Mark/" class="category-chain-item">Mark</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/Go/">#Go</a> <a href="/tags/RPC/">#RPC</a> <a href="/tags/Framework/">#Framework</a></div></div><div class="license-box my-3"><div class="license-title"><div>从零实现系列｜RPC</div><div>https://www.aimtao.net/7days-rpc/</div></div><div class="license-meta"><div class="license-meta-item license-meta-date"><div>Posted on</div><div>2024-10-18</div></div><div class="license-meta-item"><div>Licensed under</div><div><a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="BY - Attribution"><i class="iconfont icon-by"></i> </span></a><a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="NC - Non-commercial"><i class="iconfont icon-nc"></i> </span></a><a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="SA - Share-alike"><i class="iconfont icon-sa"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"></article><article class="post-next col-6"><a href="/copy-lock-value/" title="Golang 中返回含锁对象的风险"><span class="hidden-mobile">Golang 中返回含锁对象的风险</span> <span class="visible-mobile">Next</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments"><div id="valine"></div><style>.v[data-class=v] .veditor{background-image:url(https://hutu0.aimtao.net/foot/drinkwater.webp);background-size:contain;background-repeat:no-repeat;background-position:right;resize:none}</style><script type="text/javascript">Fluid.utils.loadComments("#valine",(function(){Fluid.utils.createScript("https://cdn.staticfile.org/valine/1.4.18/Valine.min.js",(function(){var e=Object.assign({appId:"Lwz6D7d9XSdSYpjixPxukzhF-gzGzoHsz",appKey:"UhkN5uCsv1zxjYO6nJ7vOjpB",path:"window.location.pathname",placeholder:"本站支持评论邮件提醒功能，在上方输入邮箱，即可收到回复通知！（支持 markdown 语法）",avatar:"robohash",meta:["nick","mail","link"],requiredFields:[],pageSize:10,lang:"zh-CN",highlight:!0,recordIP:!0,serverURLs:"https://valine.aimtao.net",emojiCDN:"https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/",emojiMaps:{666:"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/6c/2022_666_org.png","微笑":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/e3/2018new_weixioa02_org.png","可爱":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/09/2018new_keai_org.png","太开心":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/1e/2018new_taikaixin_org.png","鼓掌":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/6e/2018new_guzhang_org.png","嘻嘻":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/33/2018new_xixi_org.png","哈哈":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/8f/2018new_haha_org.png","笑cry":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/4a/2018new_xiaoku_thumb.png","挤眼":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/43/2018new_jiyan_org.png","馋嘴":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/fa/2018new_chanzui_org.png","黑线":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/a3/2018new_heixian_org.png","汗":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/28/2018new_han_org.png","挖鼻":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/9a/2018new_wabi_thumb.png","哼":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/7c/2018new_heng_org.png","怒":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/f6/2018new_nu_org.png","委屈":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/a5/2018new_weiqu_org.png","可怜":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/96/2018new_kelian_org.png","失望":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/aa/2018new_shiwang_org.png","悲伤":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/ee/2018new_beishang_org.png","泪":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/6e/2018new_leimu_org.png","允悲":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/83/2018new_kuxiao_org.png","苦涩":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/7e/2021_bitter_org.png","害羞":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/c1/2018new_haixiu_org.png","污":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/10/2018new_wu_org.png","爱你":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/f6/2018new_aini_org.png","亲亲":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/2c/2018new_qinqin_org.png","抱一抱":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/af/2020_hug_org.png","色":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/9d/2018new_huaxin_org.png","憧憬":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/c9/2018new_chongjing_org.png","舔屏":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/3e/2018new_tianping_org.png","哇":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/3d/2022_wow_org.png","坏笑":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/4d/2018new_huaixiao_org.png","阴险":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/9e/2018new_yinxian_org.png","笑而不语":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/2d/2018new_xiaoerbuyu_org.png","偷笑":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/71/2018new_touxiao_org.png","酷":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/c4/2018new_ku_org.png","并不简单":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/aa/2018new_bingbujiandan_org.png","思考":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/30/2018new_sikao_org.png","疑问":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/b8/2018new_ningwen_org.png","费解":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/2a/2018new_wenhao_org.png","晕":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/07/2018new_yun_org.png","衰":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/a2/2018new_shuai_org.png","骷髅":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/a1/2018new_kulou_org.png","嘘":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/b0/2018new_xu_org.png","闭嘴":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/62/2018new_bizui_org.png","傻眼":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/dd/2018new_shayan_org.png","裂开":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/1b/202011_liekai_org.png","感冒":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/8c/2022_cold_org.png","吃惊":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/49/2018new_chijing_org.png","吐":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/08/2018new_tu_org.png","生病":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/3b/2018new_shengbing_org.png","拜拜":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/fd/2018new_baibai_org.png","鄙视":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/da/2018new_bishi_org.png","白眼":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/ef/2018new_landelini_org.png","左哼哼":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/43/2018new_zuohengheng_org.png","右哼哼":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/c1/2018new_youhengheng_org.png","抓狂":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/17/2018new_zhuakuang_org.png","怒骂":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/87/2018new_zhouma_org.png","打脸":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/cb/2018new_dalian_org.png","顶":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/ae/2018new_ding_org.png","互粉":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/86/2018new_hufen02_org.png","钱":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/a2/2018new_qian_org.png","哈欠":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/55/2018new_dahaqian_org.png","困":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/3c/2018new_kun_org.png","睡":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/e2/2018new_shuijiao_thumb.png","赢牛奶":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/9c/2021_yingniunai_org.png","开学季":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/72/2021_kaixueji_org.png","求饶":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/aa/moren_qiurao02_org.png","吃瓜":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/01/2018new_chigua_org.png","打call":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/39/moren_dacall02_org.png",awsl:"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/14/moren_awsl02_org.png","彩虹屁":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/4b/2022_praise_org.png","酸":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/b3/hot_wosuanle_org.png",doge:"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/a1/2018new_doge02_org.png","二哈":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/22/2018new_erha_org.png","喵喵":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/7b/2018new_miaomiao_org.png","单身狗":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/20/2021_alongdog_org.png","揣手":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/af/2022_chuaishou_org.png","举手":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/fd/2022_raisehand_org.png","抱抱":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/42/2018new_baobao_org.png","摊手":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/62/2018new_tanshou_org.png","跪了":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/75/2018new_gui_org.png","握手":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/e9/2018new_woshou_org.png","赞":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/e6/2018new_zan_org.png",good:"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/8a/2018new_good_org.png","弱":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/3d/2018new_ruo_org.png","耶":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/29/2018new_ye_org.png","拳头":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/86/2018new_quantou_org.png",ok:"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/45/2018new_ok_org.png","加油":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/9f/2018new_jiayou_org.png","作揖":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/e7/2018new_zuoyi_org.png",haha:"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/1d/2018new_hahashoushi_org.png","鲜花":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/d4/2018new_xianhua_org.png","杰瑞":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/da/2021_jerry_org.png","汤姆":"https://face.t.sinajs.cn/t4/appstyle/expression/ext/normal/31/2021_tom_org.png","tvgif-白眼":"https://i0.hdslb.com/bfs/emote/48f75163437445665a9be80bb316e4cb252c5415.gif","tvgif-doge":"https://i0.hdslb.com/bfs/emote/302d6c88c63ed162c81a49cafe7ed2709e6fb955.gif","tvgif-坏笑":"https://i0.hdslb.com/bfs/emote/5d2572efd09aab5dde9e2a198bb3f9ac1e2a982e.gif","tvgif-难过":"https://i0.hdslb.com/bfs/emote/9c6b41008a67755410f712334c64313df5f91b3f.gif","tvgif-生气":"https://i0.hdslb.com/bfs/emote/1902a5a2df5b5c931d88c12f0feb264b1e109d0d.gif","tvgif-委屈":"https://i0.hdslb.com/bfs/emote/af5a5853edb43a8178a8cb5df707fa5e88143699.gif","tvgif-斜眼笑":"https://i0.hdslb.com/bfs/emote/c66568b471192ca1f62f6ed4384dc1b283ab7508.gif","tvgif-呆":"https://i0.hdslb.com/bfs/emote/d3fa91e4db9215eb1e20ab9da44f1214aa4bda7b.gif","tvgif-发怒":"https://i0.hdslb.com/bfs/emote/3959eb81b952e4fa8d269d98f9e3639172d84073.gif","tvgif-惊吓":"https://i0.hdslb.com/bfs/emote/13549060757fcd92b11d0657d9b3b6038f97abb6.gif","tvgif-呕吐":"https://i0.hdslb.com/bfs/emote/db58e9442aae26694af18cc1683607cca3a16763.gif","tvgif-思考":"https://i0.hdslb.com/bfs/emote/b63f9146bfd985af014f8d6d4bdb498805be48f9.gif","tvgif-微笑":"https://i0.hdslb.com/bfs/emote/b98656855d782f61cb8edc7f7fca6563ecafff7e.gif","tvgif-疑问":"https://i0.hdslb.com/bfs/emote/fce1b1a0f3b0e39a2dc16a18508dba7b91e929f4.gif","tvgif-大哭":"https://i0.hdslb.com/bfs/emote/cba61f05f3039b02a7ffc0dfcd9d7995df9fdd74.gif","tvgif-鼓掌":"https://i0.hdslb.com/bfs/emote/be106e6b265883a9f28fbe10f7b765701e2618d4.gif","tvgif-抠鼻":"https://i0.hdslb.com/bfs/emote/696d9f93e722144dc2a78aeffc569418fdf3d565.gif","tvgif-亲亲":"https://i0.hdslb.com/bfs/emote/3534ea44ab74bd20352b88c245a06c4b4c46d271.gif","tvgif-调皮":"https://i0.hdslb.com/bfs/emote/fcd967395fd14e4dd5829fa7e8a967ce23205e52.gif","tvgif-笑哭":"https://i0.hdslb.com/bfs/emote/1c2fd1e8c9dde12812f86e5d4cbddd8993d98082.gif","tvgif-晕":"https://i0.hdslb.com/bfs/emote/030040ec5c9ddc9e3d067658c4139e7314ab42f8.gif","tvgif-点赞":"https://i0.hdslb.com/bfs/emote/30ecff401245fb56bcc1cf588d1809ac1ab1607c.gif","tvgif-害羞":"https://i0.hdslb.com/bfs/emote/411a3e459e8580f5bfd9f639a408247c4b509935.gif","tvgif-睡着":"https://i0.hdslb.com/bfs/emote/3c8b5e293261287a6203597e29b3de07df4d18c6.gif","tvgif-色":"https://i0.hdslb.com/bfs/emote/a0c6d99ab0ab63b8648f5283ff72cec04b604828.gif","tvgif-吐血":"https://i0.hdslb.com/bfs/emote/e17e4539e169d14a3389ff147afea760cebe5de5.gif","tvgif-无奈":"https://i0.hdslb.com/bfs/emote/eb4cb5f07cfd177c7e6a7914316717e56d9cc1d0.gif","tvgif-再见":"https://i0.hdslb.com/bfs/emote/344f61609ecce2008520dc8a977b6169215748a9.gif","tvgif-流汗":"https://i0.hdslb.com/bfs/emote/390bccec65eaff536bd5bb2a0c5b8b0bdea47334.gif","tvgif-偷笑":"https://i0.hdslb.com/bfs/emote/7f11e6f7f63e79112b833bd41fa13a83d7cd8474.gif","tvgif-抓狂":"https://i0.hdslb.com/bfs/emote/a476b93ecd8e94ac3257323fd822f91cef212de2.gif","tvgif-黑人问号":"https://i0.hdslb.com/bfs/emote/b609adf664be33224a9923262031165ae3e34cd2.gif","tvgif-困":"https://i0.hdslb.com/bfs/emote/91c2bf34ecf842d7016c01d841db3d4074bd281f.gif","tvgif-打脸":"https://i0.hdslb.com/bfs/emote/b0fad4856e59c1240e448437da3287bb5ce547e5.gif","tvgif-闭嘴":"https://i0.hdslb.com/bfs/emote/a3fc5388b09e945be3f18fe23bfed5874a0285b7.gif","tvgif-鄙视":"https://i0.hdslb.com/bfs/emote/293b5d459e6264ecf314d20937a936fa672ccd1e.gif","tvgif-腼腆":"https://i0.hdslb.com/bfs/emote/30984e8264324f901d19bea85dada7103b695534.gif","tvgif-馋":"https://i0.hdslb.com/bfs/emote/2525c5703c594e5f0752f68db8948773caebde47.gif","tvgif-可爱":"https://i0.hdslb.com/bfs/emote/f92d20f76258bc5f33fc9d7c5e2a1d41fef19a7c.gif","tvgif-发财":"https://i0.hdslb.com/bfs/emote/76131e52c9b033681b4c896c6024d29ef7ec7ec2.gif","tvgif-生病":"https://i0.hdslb.com/bfs/emote/beb94829fe04f1a41bd6ca611e1f6ca9ca169afa.gif","tvgif-流鼻血":"https://i0.hdslb.com/bfs/emote/8ef473f74a849420da712487b2f56ecca1f695f5.gif","tvgif-尴尬":"https://i0.hdslb.com/bfs/emote/e0b84ef5ee3e5b8978e584c7c5a6550c51d15f84.gif","tvgif-大佬":"https://i0.hdslb.com/bfs/emote/14ca0c05382b8741940942b2430b7a8d55c02f7e.gif","暹罗猫小豆泥-抱大腿":"https://i0.hdslb.com/bfs/emote/1e309b348e969e7ff1c7d873352799a2005494d5.png","暹罗猫小豆泥-不要":"https://i0.hdslb.com/bfs/emote/00d5e138feb370186c4e473061b21b42f8a3ea36.png","暹罗猫小豆泥-呆滞":"https://i0.hdslb.com/bfs/emote/b6ec6210f8c7095f4a14ccf8a6ec1b60fb1aa416.png","暹罗猫小豆泥-单纯":"https://i0.hdslb.com/bfs/emote/e5cdb0d44f35f545d37cbc95ca09cdb9f79ebf48.png","暹罗猫小豆泥-好耶":"https://i0.hdslb.com/bfs/emote/5fc0be80c750a057d1c068a9a3c65c7b09a49e02.png","暹罗猫小豆泥-惊讶":"https://i0.hdslb.com/bfs/emote/d6024fd52d7e66241062c045559974e2a4c6e87f.png","暹罗猫小豆泥-哭":"https://i0.hdslb.com/bfs/emote/9153d549e425cc02eb911695fff29cb59b338da0.png","暹罗猫小豆泥-来了":"https://i0.hdslb.com/bfs/emote/d5d12b9d885346de164f30d41a10f235872aaefa.png","暹罗猫小豆泥-呸":"https://i0.hdslb.com/bfs/emote/a7f7d5a13c8d1c1ff116e7362108fb49045b4b72.png","暹罗猫小豆泥-探头":"https://i0.hdslb.com/bfs/emote/4741a1d527c52365850368b2f480d5818b23cb8f.png","暹罗猫小豆泥-舔":"https://i0.hdslb.com/bfs/emote/d071edebf8d3fbad73d773e9049eee2a0c28f1d5.png","暹罗猫小豆泥-投币":"https://i0.hdslb.com/bfs/emote/77b10ddaf24b4547e712ba8ae8f8e51ca8c38bb1.png","暹罗猫小豆泥-苦鲁西":"https://i0.hdslb.com/bfs/emote/ad3b14a2a5cf6680468222581a9964577eaca3d3.png","暹罗猫小豆泥-再见":"https://i0.hdslb.com/bfs/emote/e4c72ecf403858750b881030d650769e79017561.png","暹罗猫小豆泥-震惊":"https://i0.hdslb.com/bfs/emote/7caf9631dfb93071a843e308e5382799494d3a71.png"},enableQQ:!1},{el:"#valine",path:window.location.pathname});new Valine(e),Fluid.utils.waitElementVisible("#valine .vcontent",()=>{var e="#valine .vcontent img:not(.vemoji)";Fluid.plugins.imageCaption(e),Fluid.plugins.fancyBox(e)})}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><button id="floating-toc-button" class="floating-toc-button"><i class="iconfont icon-list"></i></button><div id="floating-toc" class="floating-toc"><div class="floating-toc-header"><i class="iconfont icon-list"></i></div><div class="floating-toc-body"><ul class="floating-toc-list" id="floating-toc-list"></ul></div></div><script>document.addEventListener("DOMContentLoaded",(function(){var t=document.getElementById("floating-toc-button"),e=document.getElementById("floating-toc"),n=document.getElementById("floating-toc-list"),o=!1,d=0,i=0;t.addEventListener("mousedown",(function(e){o=!0,d=e.clientX-t.offsetLeft,i=e.clientY-t.offsetTop})),document.addEventListener("mousemove",(function(e){o&&(t.style.left=e.clientX-d+"px",t.style.top=e.clientY-i+"px")})),document.addEventListener("mouseup",(function(){o=!1})),t.addEventListener("touchstart",(function(e){o=!0,d=e.touches[0].clientX-t.offsetLeft,i=e.touches[0].clientY-t.offsetTop})),document.addEventListener("touchmove",(function(e){o&&(t.style.left=e.touches[0].clientX-d+"px",t.style.top=e.touches[0].clientY-i+"px")})),document.addEventListener("touchend",(function(){o=!1})),t.addEventListener("click",(function(){e.classList.toggle("active")})),document.querySelectorAll(".markdown-body h1, .markdown-body h2, .markdown-body h3, .markdown-body h4, .markdown-body h5, .markdown-body h6").forEach((function(t){var o=parseInt(t.tagName.charAt(1)),d=document.createElement("li"),i=document.createElement("a");i.classList.add("floating-toc-link"),i.textContent=t.textContent,i.setAttribute("href","#"+t.getAttribute("id")),d.classList.add("floating-toc-list-item"),d.classList.add("level-"+o),d.appendChild(i),n.appendChild(d),i.addEventListener("click",(function(n){n.preventDefault();var o=t.getAttribute("id"),d=document.getElementById(o),i=document.getElementsByClassName("header-inner")[0];if(d&&i){var c=window.pageYOffset,a=d.offsetTop+i.offsetHeight-c,s=null;window.requestAnimationFrame((function t(e){s||(s=e);var n,o=e-s,d=Math.min(o/1e3,1),i=(n=d)<.5?2*n*n:(4-2*n)*n-1;window.scrollTo(0,c+a*i),o<1e3&&window.requestAnimationFrame(t)}))}e.classList.remove("active")}))}))}))</script><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">Search</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">Keyword</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="statistics"><span id="leancloud-site-pv-container" style="display:none"><i class="iconfont iconPV"></i> <span id="leancloud-site-pv"></span> </span><span id="leancloud-site-uv-container" style="display:none"><i class="iconfont iconUV"></i> <span id="leancloud-site-uv"></span></span></div><div class="beian"><span><i class="iconfont iconICP-13"></i> <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">鄂 ICP 备 2 0 0 0 0 5 0 2 号</a></span></div><div class="footer-content"><a href="https://www.aimtao.net/categories/Mark/" rel="nofollow noopener"><span id="aimtao">© 2024 AimTao </span></a><i class="iconfont icon-love"></i> <span id="timeDate">loading...</span> <span id="times">loading...</span><script>var now=new Date;function createtime(){var n=new Date("11/28/2018 15:28:05");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("timeDate").innerHTML="&nbsp"+dnum+"&nbsp天",document.getElementById("times").innerHTML=hnum+"&nbsp小时&nbsp"+mnum+"&nbsp分&nbsp"+snum+"&nbsp秒"}setInterval("createtime()",250)</script></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script defer>if(!Fluid.ctx.dnt){var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?07fe5d228ae82eadee00480515f9d64b";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()}</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var o=jQuery("#board-ctn").offset().top;window.tocbot.init({tocSelector:"#toc-body",contentSelector:".markdown-body",headingSelector:CONFIG.toc.headingSelector||"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:CONFIG.toc.collapseDepth||0,scrollSmooth:!0,headingsOffset:-o}),t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))</script><script>!function(){var e=CONFIG.code_language.enable&&CONFIG.code_language.default,a=CONFIG.copy_btn;if(e||a){var i="";i+='<div class="code-widget">',i+="LANG",i+="</div>",jQuery(".markdown-body pre").each((function(){var n=jQuery(this);if(!(n.find("code.mermaid").length>0||n.find("span.line").length>0)){var t,c="";e&&(c=CONFIG.code_language.default,n[0].children.length>0&&n[0].children[0].classList.length>=2&&n.children().hasClass("hljs")?c=n[0].children[0].classList[1]:n[0].getAttribute("data-language")?c=n[0].getAttribute("data-language"):n.parent().hasClass("sourceCode")&&n[0].children.length>0&&n[0].children[0].classList.length>=2?(c=n[0].children[0].classList[1],n.parent().addClass("code-wrapper")):n.parent().hasClass("markdown-body")&&0===n[0].classList.length&&n.wrap('<div class="code-wrapper"></div>'),c=c.toUpperCase().replace("NONE",CONFIG.code_language.default)),n.append(i.replace("LANG",c).replace('code-widget">',(t=n[0],(Fluid.utils.getBackgroundLightness(t)>=0?"code-widget-light":"code-widget-dark")+(a?' code-widget copy-btn" data-clipboard-snippet><i class="iconfont icon-copy"></i>':' code-widget">')))),a&&Fluid.utils.createScript("https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js",(function(){new window.ClipboardJS(".copy-btn",{target:function(e){for(var a=e.parentNode.childNodes,i=0;i<a.length;i++)if("CODE"===a[i].tagName)return a[i]}}).on("success",(function(e){e.clearSelection(),e.trigger.innerHTML=e.trigger.innerHTML.replace("icon-copy","icon-success"),setTimeout((function(){e.trigger.innerHTML=e.trigger.innerHTML.replace("icon-success","icon-copy")}),2e3)}))}))}}))}}()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var o=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),n=[];for(var i of o)n.push(".markdown-body > "+i.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(n.join(", "))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script defer src="/js/leancloud.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">Blog works best with JavaScript enabled</div></noscript></body></html>